<!DOCTYPE html>
<html lang="en" class="dark">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="public/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="public/favicon.svg" />
  <link rel="shortcut icon" href="public/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="public/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-title" content="Nine" />
  <link rel="manifest" href="public/site.webmanifest" />
  <title>Quiz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            slate: {
              850: "#151e2e",
              900: "#0f172a",
              950: "#020617",
            },
            indigo: {
              450: "#7078ff",
            },
          },
          fontFamily: {
            sans: ["Inter", "Sarabun", "system-ui", "sans-serif"],
          },
          animation: {
            "fade-in": "fadeIn 0.4s ease-out forwards",
            "slide-up": "slideUp 0.4s ease-out forwards",
            shake: "shake 0.5s cubic-bezier(.36,.07,.19,.97) both",
          },
          keyframes: {
            fadeIn: {
              "0%": { opacity: "0" },
              "100%": { opacity: "1" },
            },
            slideUp: {
              "0%": { opacity: "0", transform: "translateY(20px)" },
              "100%": { opacity: "1", transform: "translateY(0)" },
            },
            shake: {
              "10%, 90%": { transform: "translate3d(-1px, 0, 0)" },
              "20%, 80%": { transform: "translate3d(2px, 0, 0)" },
              "30%, 50%, 70%": { transform: "translate3d(-4px, 0, 0)" },
              "40%, 60%": { transform: "translate3d(4px, 0, 0)" },
            },
          },
        },
      },
    };
  </script>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Sarabun:wght@300;400;500;600;700&display=swap");

    body {
      background-color: #020617;
      color: #e2e8f0;
    }

    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #0f172a;
    }

    ::-webkit-scrollbar-thumb {
      background: #334155;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #475569;
    }

    .option-card {
      transition: all 0.2s ease;
    }

    .option-card:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
    }

    .glass-panel {
      background: rgba(15, 23, 42, 0.7);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .draggable-item {
      cursor: grab;
      touch-action: none;
      transition: transform 0.08s cubic-bezier(0.2, 0, 0, 1), box-shadow 0.08s;
    }

    .draggable-item:active {
      cursor: grabbing;
    }

    .draggable-item.dragging {
      opacity: 0.5;
      background: #1e293b;
      border: 1px dashed #6366f1;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
      z-index: 50;
    }

    .draggable-item.dragging>* {
      opacity: 0.5;
    }
  </style>
</head>

<body class="antialiased min-h-screen flex flex-col items-center justify-center p-4">
  <div class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
    <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-indigo-500/10 rounded-full blur-[100px]"></div>
    <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-purple-500/10 rounded-full blur-[100px]"></div>
  </div>

  <main id="app" class="w-full max-w-2xl mx-auto relative z-10">
    <div id="loading-screen" class="text-center animate-fade-in">
      <div
        class="inline-block w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mb-4">
      </div>
      <p class="text-slate-400 tracking-wide text-sm font-medium">
        LOADING QUIZ DATA
      </p>
    </div>

    <div id="subject-screen" class="hidden glass-panel rounded-2xl p-8 md:p-12 shadow-2xl animate-slide-up">
      <div class="mb-6 inline-flex items-center justify-center w-16 h-16 rounded-full bg-indigo-500/10 text-indigo-400">
        <i class="ph ph-book-open text-3xl"></i>
      </div>
      <h1 class="text-3xl md:text-4xl font-bold mb-3 text-white tracking-tight">
        เลือกวิชา
      </h1>
      <p class="text-slate-400 mb-8 mx-auto leading-relaxed">
        เลือกวิชาที่ต้องการทำแบบทดสอบ
      </p>
      <div id="subject-selection" class="grid grid-cols-1 gap-3">
        <!-- <button onclick="quizApp.selectSubject('english')"
                    class="w-full p-4 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-medium transition-colors shadow-lg shadow-indigo-500/20 flex items-center justify-center gap-3">
                    English
                </button> -->
        <button onclick="quizApp.selectSubject('hamlet')"
          class="w-full p-4 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-medium transition-colors shadow-lg shadow-indigo-500/20 flex items-center justify-center gap-3">
          Hamlet + Aim High Vocab
        </button>
        <button
          class="w-full p-4 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-medium transition-colors shadow-lg shadow-indigo-500/20 flex items-center justify-center gap-3"
          onclick="window.location.href='/flashcard'">
          Biology Flashcard (คำศัพท์)
        </button>
      </div>
    </div>

    <div id="start-screen" class="hidden glass-panel rounded-2xl p-8 md:p-12 text-center shadow-2xl animate-slide-up">
      <div class="mb-6 inline-flex items-center justify-center w-16 h-16 rounded-full bg-indigo-500/10 text-indigo-400">
        <i class="ph ph-lightning text-3xl"></i>
      </div>
      <h1 class="text-3xl md:text-4xl font-bold mb-3 text-white tracking-tight">
        ทดสอบความรู้
      </h1>
      <p class="text-slate-400 mb-8 max-w-md mx-auto leading-relaxed">
        คำถามจะถูกสุ่มใหม่ทุกครั้งที่คุณเริ่มทำแบบทดสอบ
      </p>
      <button onclick="quizApp.startQuiz()"
        class="group relative px-8 py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-medium transition-all duration-200 overflow-hidden">
        <span class="relative z-10">เริ่มทำแบบทดสอบ</span>
        <div
          class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300">
        </div>
      </button>
    </div>

    <div id="quiz-interface" class="hidden w-full">
      <div class="flex items-center justify-between mb-6 px-1">
        <div class="flex items-center gap-4">
          <div class="flex items-center gap-2 text-sm font-medium text-slate-400">
            <span id="progress-text">Question 1/5</span>
          </div>
        </div>

        <div class="h-1.5 flex-1 mx-4 bg-slate-800 rounded-full overflow-hidden">
          <div id="progress-bar" class="h-full bg-indigo-500 transition-all duration-500 ease-out" style="width: 0%">
          </div>
        </div>

        <div class="flex items-center gap-3">
          <div class="text-sm font-bold text-indigo-400">
            คะแนน: <span id="current-score">0</span>
          </div>
          <button id="reset-quiz-btn"
            class="flex items-center gap-2 p-1.5 rounded-lg bg-slate-800 hover:bg-red-500/20 hover:text-red-400 text-slate-400 transition-colors border border-white/5"
            title="Start New Quiz">
            <i class="ph ph-arrow-counter-clockwise text-lg"></i>
            <span>เริ่มทำใหม่</span>
          </button>
        </div>
      </div>

      <div id="question-card"
        class="glass-panel rounded-2xl p-6 md:p-8 shadow-xl min-h-[400px] flex flex-col relative overflow-hidden transition-all duration-300">
        <div class="absolute top-2.5 right-6">
          <span id="q-type-badge"
            class="px-2 py-0.5 text-xs font-semibold uppercase tracking-wider text-indigo-300 bg-indigo-500/10 rounded-full border border-indigo-500/20">
            Multiple Choice
          </span>
        </div>

        <h2 id="q-text" class="text-xl md:text-2xl font-semibold mb-8 mt-4 text-white leading-tight"></h2>

        <div id="q-content" class="flex-grow flex flex-col justify-center gap-4"></div>

        <div id="feedback-area" class="mt-8 pt-6 border-t border-white/5 hidden">
          <div id="feedback-message"
            class="mb-4 p-4 rounded-lg bg-green-500/10 border border-green-500/20 text-green-300 text-sm font-medium flex items-center gap-3">
            <i class="ph ph-check-circle text-xl"></i>
            <span>ถูกต้อง!</span>
          </div>
          <button id="next-btn"
            class="w-full py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-lg font-medium transition-colors border border-white/10 flex items-center justify-center gap-2">
            คำถามถัดไป <i class="ph ph-arrow-right"></i>
          </button>
        </div>

        <div id="submit-area" class="mt-8 pt-4 hidden">
          <button id="submit-btn"
            class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-medium transition-colors shadow-lg shadow-indigo-500/20">
            ส่งคําตอบ
          </button>
        </div>
      </div>
    </div>

    <div id="results-screen" class="hidden glass-panel rounded-2xl p-8 md:p-12 text-center shadow-2xl animate-fade-in">
      <div id="score-icon"
        class="mb-6 inline-flex items-center justify-center w-20 h-20 rounded-full bg-emerald-500/10 text-emerald-400">
        <i class="ph ph-trophy text-4xl"></i>
      </div>
      <h2 class="text-3xl font-bold mb-2 text-white">ทำแบบทดสอบเสร็จแล้ว!</h2>
      <p class="text-slate-400 mb-8">นี่คือผลการทำแบบทดสอบของคุณ</p>

      <div class="grid grid-cols-2 gap-4 mb-8">
        <div class="bg-slate-800/50 p-4 rounded-xl border border-white/5">
          <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">
            คะแนน
          </div>
          <div class="text-3xl font-bold text-white">
            <span id="final-score">0</span><span class="text-lg text-slate-500 font-normal">/</span><span
              id="total-questions" class="text-lg text-slate-500 font-normal">0</span>
          </div>
        </div>
        <div class="bg-slate-800/50 p-4 rounded-xl border border-white/5">
          <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">
            Percentage
          </div>
          <div id="final-percent" class="text-3xl font-bold text-indigo-400">
            0%
          </div>
        </div>
      </div>

      <button onclick="location.reload()"
        class="w-full py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-lg font-medium transition-colors border border-white/10">
        กลับสู่หน้าหลัก
      </button>
    </div>
  </main>

  <script>
    const STORAGE_KEY = "quiz_app_progress_v1";

    class QuizApp {
      constructor() {
        this.questions = [];
        this.currentIndex = 0;
        this.score = 0;
        this.isAnswering = false;
        this.currentOrderState = null;
        this.currentSelectedElement = null;

        this.screens = {
          loading: document.getElementById("loading-screen"),
          subject: document.getElementById("subject-screen"),
          start: document.getElementById("start-screen"),
          quiz: document.getElementById("quiz-interface"),
          results: document.getElementById("results-screen"),
        };

        this.ui = {
          progressText: document.getElementById("progress-text"),
          progressBar: document.getElementById("progress-bar"),
          currentScore: document.getElementById("current-score"),
          badge: document.getElementById("q-type-badge"),
          text: document.getElementById("q-text"),
          content: document.getElementById("q-content"),
          feedbackArea: document.getElementById("feedback-area"),
          feedbackMsg: document.getElementById("feedback-message"),
          nextBtn: document.getElementById("next-btn"),
          submitArea: document.getElementById("submit-area"),
          submitBtn: document.getElementById("submit-btn"),
          resetBtnGlobal: document.getElementById("reset-quiz-btn"),
        };

        this.subjects = {
          english: { name: "English", file: "data/English.json" },
          hamlet: { name: "Hamlet", file: "data/Hamlet.json" },
          ecoHistory: { name: "EcoHistory", file: "data/EcoHistory.json" },
        };

        this.init();
      }

      async init() {
        // Setup Global Reset Button
        this.ui.resetBtnGlobal.onclick = () => {
          if (
            confirm(
              "ต้องการเริ่มทำแบบทดสอบใหม่หรือไม่? ความคืบหน้าปัจจุบันจะหายไป"
            )
          ) {
            this.clearProgress();
            location.reload();
          }
        };

        // Check for saved progress
        if (this.loadProgress()) {
          this.showScreen("quiz");
          this.updateScoreUI();
          this.renderQuestion();
        } else {
          this.showScreen("subject");
        }
      }

      // --- Storage Methods ---

      saveProgress() {
        const state = {
          questions: this.questions,
          currentIndex: this.currentIndex,
          score: this.score,
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      }

      loadProgress() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          try {
            const state = JSON.parse(saved);
            if (
              state.questions &&
              Array.isArray(state.questions) &&
              state.questions.length > 0
            ) {
              this.questions = state.questions;
              this.currentIndex = state.currentIndex || 0;
              this.score = state.score || 0;
              return true;
            }
          } catch (e) {
            console.error("Failed to parse saved progress", e);
            this.clearProgress();
          }
        }
        return false;
      }

      clearProgress() {
        localStorage.removeItem(STORAGE_KEY);
      }

      // --- Logic ---

      async selectSubject(subjectKey) {
        try {
          this.showScreen("loading");
          const subject = this.subjects[subjectKey];
          const response = await fetch(subject.file);
          const data = await response.json();

          this.questions = this.shuffleArray(data);

          this.showScreen("start");
        } catch (error) {
          console.error("Failed to load quiz data", error);
          this.screens.loading.innerHTML =
            '<p class="text-red-400">Error loading quiz data.</p>';
        }
      }

      shuffleArray(array) {
        const newArr = [...array];
        for (let i = newArr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
        }
        return newArr;
      }

      showScreen(screenName) {
        Object.values(this.screens).forEach((el) =>
          el.classList.add("hidden")
        );
        this.screens[screenName].classList.remove("hidden");
      }

      startQuiz() {
        this.currentIndex = 0;
        this.score = 0;
        this.saveProgress(); // Initial Save
        this.updateScoreUI();
        this.showScreen("quiz");
        this.renderQuestion();
      }

      updateScoreUI() {
        this.ui.currentScore.textContent = this.score;
        this.ui.progressText.textContent = `Question ${this.currentIndex + 1
          }/${this.questions.length}`;
        const pct = (this.currentIndex / this.questions.length) * 100;
        this.ui.progressBar.style.width = `${pct}%`;
      }

      renderQuestion() {
        if (this.currentIndex >= this.questions.length) {
          this.finishQuiz();
          return;
        }

        const q = this.questions[this.currentIndex];
        this.ui.content.innerHTML = "";
        this.ui.feedbackArea.classList.add("hidden");
        this.ui.submitArea.classList.add("hidden");

        this.ui.submitBtn.disabled = false;
        this.ui.submitBtn.classList.remove(
          "opacity-50",
          "cursor-not-allowed"
        );

        if (this.ui.resetBtn) {
          this.ui.resetBtn.disabled = false;
          this.ui.resetBtn.classList.remove(
            "opacity-50",
            "cursor-not-allowed"
          );
        }

        this.isAnswering = true;
        this.currentOrderState = null;
        this.currentSelectedElement = null;
        this.updateScoreUI();

        const card = document.getElementById("question-card");
        card.classList.remove("animate-shake");
        card.classList.remove("animate-fade-in");
        void card.offsetWidth;
        card.classList.add("animate-fade-in");

        this.ui.text.textContent = q.question;

        const typeLabels = {
          multiple_choice: "เลือกคําตอบ",
          true_false: "True / False",
          short_answer: "พิมพ์คําตอบ",
          matching: "จับคู่",
          ordering: "เรียงลําดับ",
        };
        this.ui.badge.textContent = typeLabels[q.type] || "Question";
        this.ui.badge.className =
          "px-2 py-0.5 text-xs font-semibold uppercase tracking-wider text-indigo-300 bg-indigo-500/10 rounded-full border border-indigo-500/20";

        switch (q.type) {
          case "multiple_choice":
            this.renderMultipleChoice(q);
            break;
          case "true_false":
            this.renderTrueFalse(q);
            break;
          case "short_answer":
            this.renderShortAnswer(q);
            break;
          case "matching":
            this.renderMatching(q);
            break;
          case "ordering":
            this.renderOrdering(q);
            break;
        }
      }

      renderMultipleChoice(q) {
        const options = this.shuffleArray(q.options);
        const grid = document.createElement("div");
        grid.className = "grid grid-cols-1 gap-3";

        options.forEach((opt) => {
          const btn = document.createElement("button");
          btn.className =
            "option-card w-full text-left p-4 rounded-xl bg-slate-800/50 border border-white/10 hover:bg-slate-700/50 hover:border-indigo-500/50 transition-all text-slate-200 font-medium group";
          btn.dataset.value = opt;
          btn.textContent = opt;
          btn.onclick = (e) => {
            this.currentSelectedElement = e.currentTarget;
            this.handleAnswer(opt === q.correct, q.correct);
          };
          grid.appendChild(btn);
        });
        this.ui.content.appendChild(grid);
      }

      renderTrueFalse(q) {
        const grid = document.createElement("div");
        grid.className = "grid grid-cols-2 gap-4";

        ["True", "False"].forEach((opt) => {
          const isTrue = opt === "True";
          const btn = document.createElement("button");
          btn.className =
            "option-card py-8 rounded-xl bg-slate-800/50 border border-white/10 hover:bg-slate-700/50 hover:border-indigo-500/50 transition-all text-xl font-semibold text-white";
          btn.dataset.value = opt;
          btn.textContent = opt;
          btn.onclick = (e) => {
            this.currentSelectedElement = e.currentTarget;
            this.handleAnswer(
              isTrue === q.correct,
              q.correct ? "True" : "False"
            );
          };
          grid.appendChild(btn);
        });
        this.ui.content.appendChild(grid);
      }

      renderShortAnswer(q) {
        const wrapper = document.createElement("div");
        wrapper.className = "w-full";

        const input = document.createElement("input");
        input.type = "text";
        input.placeholder = "พิมพ์คําตอบ...";
        input.className =
          "w-full bg-slate-800/50 border border-white/10 rounded-xl p-4 text-white focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all";

        wrapper.appendChild(input);
        this.ui.content.appendChild(wrapper);

        this.ui.submitArea.innerHTML = `<button id="submit-btn" class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-medium transition-colors shadow-lg shadow-indigo-500/20">ส่งคําตอบ</button>`;
        this.ui.submitArea.classList.remove("hidden");
        this.ui.submitBtn = document.getElementById("submit-btn");
        this.ui.submitBtn.onclick = () => {
          const val = input.value.trim().toLowerCase();
          const correct = q.correct.toLowerCase();
          this.handleAnswer(val === correct, q.correct);
        };
      }

      renderMatching(q) {
        let leftItems = this.shuffleArray(
          [...q.pairs].map((p, i) => ({ text: p.left, id: i }))
        );
        let rightItems = this.shuffleArray(
          [...q.pairs].map((p, i) => ({ text: p.right, id: i }))
        );
        let userPairs = [];
        let selectedLeft = null;
        const pairColors = [
          {
            bg: "bg-blue-500/20",
            border: "border-blue-500/50",
            text: "text-blue-200",
          },
          {
            bg: "bg-yellow-500/20",
            border: "border-yellow-500/50",
            text: "text-yellow-200",
          },
          {
            bg: "bg-purple-500/20",
            border: "border-purple-500/50",
            text: "text-purple-200",
          },
          {
            bg: "bg-pink-500/20",
            border: "border-pink-500/50",
            text: "text-pink-200",
          },
          {
            bg: "bg-indigo-500/20",
            border: "border-indigo-500/50",
            text: "text-indigo-200",
          },
          {
            bg: "bg-teal-500/20",
            border: "border-teal-500/50",
            text: "text-teal-200",
          },
          {
            bg: "bg-orange-500/20",
            border: "border-orange-500/50",
            text: "text-orange-200",
          },
          {
            bg: "bg-cyan-500/20",
            border: "border-cyan-500/50",
            text: "text-cyan-200",
          },
        ];
        const container = document.createElement("div");
        container.className = "space-y-8";
        const userPanel = document.createElement("div");
        userPanel.className = "space-y-4";
        const userTitle = document.createElement("h3");
        userTitle.className =
          "text-lg font-semibold text-white border-b border-white/10 pb-2";
        userTitle.textContent = "จับคู่ให้ถูกต้อง";
        userPanel.appendChild(userTitle);
        const userContainer = document.createElement("div");
        userContainer.className = "grid grid-cols-2 gap-4 md:gap-12 relative";
        const divider = document.createElement("div");
        divider.className =
          "absolute left-1/2 top-0 bottom-0 w-px bg-white/5 -translate-x-1/2 hidden md:block";
        userContainer.appendChild(divider);
        const leftCol = document.createElement("div");
        leftCol.className = "flex flex-col gap-3";
        const rightCol = document.createElement("div");
        rightCol.className = "flex flex-col gap-3";
        const correctPanel = document.createElement("div");
        correctPanel.className =
          "space-y-4 hidden animate-fade-in pt-4 border-t border-dashed border-white/10";
        const correctTitle = document.createElement("h3");
        correctTitle.className =
          "text-lg font-semibold text-emerald-400 flex items-center gap-2";
        correctTitle.innerHTML =
          '<i class="ph ph-key"></i> การจับคู่ที่ถูกต้อง';
        correctPanel.appendChild(correctTitle);
        const correctContainer = document.createElement("div");
        correctContainer.className = "grid grid-cols-2 gap-4 md:gap-12";
        const correctLeftCol = document.createElement("div");
        correctLeftCol.className = "flex flex-col gap-3";
        const correctRightCol = document.createElement("div");
        correctRightCol.className = "flex flex-col gap-3";
        leftItems.forEach((leftItem, index) => {
          const color = pairColors[index % pairColors.length];
          const leftBtn = document.createElement("div");
          leftBtn.className = `p-3 text-sm md:text-base rounded-lg border ${color.bg} ${color.border} ${color.text} text-left opacity-90 font-medium`;
          leftBtn.textContent = leftItem.text;
          correctLeftCol.appendChild(leftBtn);
        });
        rightItems.forEach((rightItem) => {
          const matchingLeftIndex = leftItems.findIndex(
            (l) => l.id === rightItem.id
          );
          const color = pairColors[matchingLeftIndex % pairColors.length];
          const rightBtn = document.createElement("div");
          rightBtn.className = `p-3 text-sm md:text-base rounded-lg border ${color.bg} ${color.border} ${color.text} text-left opacity-90 font-medium`;
          rightBtn.textContent = rightItem.text;
          correctRightCol.appendChild(rightBtn);
        });
        correctContainer.appendChild(correctLeftCol);
        correctContainer.appendChild(correctRightCol);
        correctPanel.appendChild(correctContainer);
        const renderCols = () => {
          leftCol.innerHTML = "";
          rightCol.innerHTML = "";
          leftItems.forEach((item, idx) => {
            const pair = userPairs.find((p) => p.leftId === item.id);
            const isPaired = !!pair;
            const btn = document.createElement("button");
            let colorClasses =
              "bg-slate-800/50 border-white/10 hover:bg-slate-700/50 text-slate-200";
            let activeRing = "";
            if (isPaired) {
              const leftIndex = leftItems.findIndex(
                (i) => i.id === pair.leftId
              );
              const color = pairColors[leftIndex % pairColors.length];
              colorClasses = `${color.bg} ${color.border} ${color.text}`;
            } else if (selectedLeft === item) {
              colorClasses = "bg-indigo-600 border-indigo-400 text-white";
              activeRing =
                "ring-2 ring-indigo-400/50 ring-offset-2 ring-offset-slate-900";
            }
            btn.className = `w-full p-4 text-sm md:text-base rounded-xl border transition-all duration-200 text-left ${colorClasses} ${activeRing}`;
            btn.textContent = item.text;
            if (!isPaired) {
              btn.onclick = () => {
                selectedLeft = item;
                renderCols();
              };
            }
            leftCol.appendChild(btn);
          });
          rightItems.forEach((item) => {
            const pair = userPairs.find((p) => p.rightId === item.id);
            const isPaired = !!pair;
            const btn = document.createElement("button");
            let colorClasses =
              "bg-slate-800/50 border-white/10 hover:bg-slate-700/50 text-slate-200";
            if (isPaired) {
              const leftIndex = leftItems.findIndex(
                (i) => i.id === pair.leftId
              );
              const color = pairColors[leftIndex % pairColors.length];
              colorClasses = `${color.bg} ${color.border} ${color.text}`;
            }
            const pulse =
              selectedLeft && !isPaired
                ? "animate-pulse ring-1 ring-indigo-500/30"
                : "";
            btn.className = `w-full p-4 text-sm md:text-base rounded-xl border transition-all duration-200 text-left ${colorClasses} ${pulse}`;
            btn.textContent = item.text;
            if (!isPaired) {
              btn.onclick = () => {
                if (selectedLeft) {
                  userPairs.push({
                    leftId: selectedLeft.id,
                    rightId: item.id,
                  });
                  selectedLeft = null;
                  renderCols();
                }
              };
            }
            rightCol.appendChild(btn);
          });
        };
        userContainer.appendChild(leftCol);
        userContainer.appendChild(rightCol);
        userPanel.appendChild(userContainer);
        container.appendChild(userPanel);
        container.appendChild(correctPanel);
        this.ui.content.appendChild(container);
        renderCols();
        this.ui.submitArea.classList.remove("hidden");
        this.ui.submitArea.innerHTML = `
                    <div class="flex gap-3">
                        <button id="reset-btn" class="flex-1 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-medium transition-colors">รีเซ็ตการจับคู่</button>
                        <button id="submit-btn" class="flex-1 py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-medium transition-colors shadow-lg shadow-indigo-500/20">ส่งคําตอบ</button>
                    </div>
                `;
        this.ui.resetBtn = document.getElementById("reset-btn");
        this.ui.submitBtn = document.getElementById("submit-btn");
        this.ui.resetBtn.onclick = () => {
          userPairs = [];
          selectedLeft = null;
          renderCols();
        };
        this.ui.submitBtn.onclick = () => {
          this.ui.submitBtn.disabled = true;
          this.ui.submitBtn.classList.add("opacity-50", "cursor-not-allowed");
          this.ui.resetBtn.disabled = true;
          this.ui.resetBtn.classList.add("opacity-50", "cursor-not-allowed");
          if (userPairs.length < leftItems.length) {
            const card = document.getElementById("question-card");
            card.classList.add("animate-shake");
            setTimeout(() => card.classList.remove("animate-shake"), 500);
            this.ui.submitBtn.disabled = false;
            this.ui.submitBtn.classList.remove(
              "opacity-50",
              "cursor-not-allowed"
            );
            this.ui.resetBtn.disabled = false;
            this.ui.resetBtn.classList.remove(
              "opacity-50",
              "cursor-not-allowed"
            );
            return;
          }
          let correctCount = 0;
          userPairs.forEach((pair) => {
            if (pair.leftId === pair.rightId) correctCount++;
          });
          userPairs.forEach((pair) => {
            const leftBtn =
              leftCol.children[
              leftItems.findIndex((i) => i.id === pair.leftId)
              ];
            const rightBtn =
              rightCol.children[
              rightItems.findIndex((i) => i.id === pair.rightId)
              ];
            const isCorrect = pair.leftId === pair.rightId;
            const leftIndex = leftItems.findIndex(
              (i) => i.id === pair.leftId
            );
            const color = pairColors[leftIndex % pairColors.length];
            leftBtn.className = leftBtn.className
              .replace(/bg-[\w/-]+ border-[\w/-]+ text-[\w/-]+/, "")
              .trim();
            rightBtn.className = rightBtn.className
              .replace(/bg-[\w/-]+ border-[\w/-]+ text-[\w/-]+/, "")
              .trim();
            if (isCorrect) {
              const successClass = `${color.bg} ${color.border} ${color.text} ring-2 ring-emerald-500/50`;
              leftBtn.className += ` ${successClass}`;
              rightBtn.className += ` ${successClass}`;
              leftBtn.innerHTML = `<span class="opacity-30 mr-2 text-xs">${leftItems.findIndex((i) => i.id === pair.leftId) + 1
                }.</span>${leftItems.find((i) => i.id === pair.leftId).text
                }<i class="ph ph-check-circle text-emerald-400 ml-2 text-lg"></i>`;
              rightBtn.innerHTML = `<span class="opacity-30 mr-2 text-xs">${rightItems.findIndex((i) => i.id === pair.rightId) + 1
                }.</span>${rightItems.find((i) => i.id === pair.rightId).text
                }<i class="ph ph-check-circle text-emerald-400 ml-2 text-lg"></i>`;
            } else {
              const errorClass = `bg-red-500/20 border-red-500 text-red-200`;
              leftBtn.className += ` ${errorClass}`;
              rightBtn.className += ` ${errorClass}`;
            }
          });
          const allBtns = container.querySelectorAll("button");
          allBtns.forEach((btn) => (btn.disabled = true));
          const isAllCorrect = correctCount === leftItems.length;
          if (!isAllCorrect) {
            correctPanel.classList.remove("hidden");
            setTimeout(() => {
              correctPanel.scrollIntoView({
                behavior: "smooth",
                block: "nearest",
              });
            }, 100);
          }
          this.handleAnswer(isAllCorrect, "");
        };
      }

      renderOrdering(q) {
        if (!this.currentOrderState) {
          this.currentOrderState = this.shuffleArray([...q.items]);
        }
        const list = document.createElement("ul");
        list.className = "flex flex-col gap-3 relative";
        const getDragAfterElement = (container, y) => {
          const draggableElements = [
            ...container.querySelectorAll(".draggable-item:not(.dragging)"),
          ];
          return draggableElements.reduce(
            (closest, child) => {
              const box = child.getBoundingClientRect();
              const offset = y - box.top - box.height / 2;
              if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
              } else {
                return closest;
              }
            },
            { offset: Number.NEGATIVE_INFINITY }
          ).element;
        };
        list.addEventListener("dragover", (e) => {
          e.preventDefault();
          const afterElement = getDragAfterElement(list, e.clientY);
          const draggable = document.querySelector(".dragging");
          if (!draggable) return;
          if (afterElement == null) {
            list.appendChild(draggable);
          } else {
            list.insertBefore(draggable, afterElement);
          }
        });
        const placeholder = document.createElement("div");
        placeholder.className =
          "bg-slate-700/50 border-2 border-dashed border-indigo-500 rounded-xl mb-3";
        placeholder.style.display = "none";

        const createItem = (item, index) => {
          const li = document.createElement("li");
          li.className =
            "draggable-item flex items-center gap-4 bg-slate-800/50 p-4 rounded-xl border border-white/10 transition-colors hover:border-indigo-500/30 group select-none cursor-grab active:cursor-grabbing";
          li.setAttribute("draggable", "true");
          li.dataset.value = item;
          const handle = document.createElement("div");
          handle.className = "text-slate-500 p-1 pointer-events-none";
          handle.innerHTML =
            '<i class="ph ph-dots-six-vertical text-xl"></i>';
          const text = document.createElement("span");
          text.className =
            "flex-grow text-slate-200 font-medium pointer-events-none";
          text.textContent = item;
          li.appendChild(handle);
          li.appendChild(text);

          // Desktop drag support
          li.addEventListener("dragstart", (e) => {
            if (!this.isAnswering) return;
            e.dataTransfer.effectAllowed = "move";
            li.classList.add("dragging");
          });
          li.addEventListener("dragend", () => {
            li.classList.remove("dragging");
            this.currentOrderState = [
              ...list.querySelectorAll(".draggable-item"),
            ].map((el) => el.dataset.value);
          });

          // Mobile touch support
          let touchStartY = 0;
          let touchStartX = 0;
          let isDragging = false;
          let initialIndex = 0;
          let initialX = 0;
          let initialY = 0;

          li.addEventListener("touchstart", (e) => {
            if (!this.isAnswering) return;
            touchStartY = e.touches[0].clientY;
            touchStartX = e.touches[0].clientX;
            initialIndex = Array.from(list.children).indexOf(li);
            li.classList.add("dragging");
            isDragging = true;

            const rect = li.getBoundingClientRect();
            initialX = rect.left;
            initialY = rect.top;
            list.removeChild(li);
            li.style.position = "fixed";
            li.style.zIndex = "1000";
            li.style.left = `${initialX}px`;
            li.style.top = `${initialY}px`;
            li.style.width = `${rect.width}px`;
            document.body.appendChild(li);

            placeholder.style.height = `${rect.height}px`;
            placeholder.style.display = "block";

            const afterElement = getDragAfterElement(list, touchStartY);
            if (afterElement == null) {
              list.appendChild(placeholder);
            } else {
              list.insertBefore(placeholder, afterElement);
            }
          });

          li.addEventListener("touchmove", (e) => {
            if (!isDragging) return;
            e.preventDefault();

            const touchY = e.touches[0].clientY;
            const touchX = e.touches[0].clientX;

            // Move the element to follow the finger
            li.style.left = `${initialX + (touchX - touchStartX)}px`;
            li.style.top = `${initialY + (touchY - touchStartY)}px`;

            // Update placeholder position
            if (placeholder.parentNode === list) {
              list.removeChild(placeholder);
            }
            const afterElement = getDragAfterElement(list, touchY);
            if (afterElement == null) {
              list.appendChild(placeholder);
            } else {
              list.insertBefore(placeholder, afterElement);
            }
          });

          li.addEventListener("touchend", (e) => {
            if (!isDragging) return;
            isDragging = false;

            li.classList.remove("dragging");
            li.style.position = "";
            li.style.zIndex = "";
            li.style.left = "";
            li.style.top = "";
            li.style.width = "";

            // Hide placeholder
            placeholder.style.display = "none";
            if (placeholder.parentNode === list) {
              list.removeChild(placeholder);
            }

            // Remove from body and insert back into list at the correct position
            document.body.removeChild(li);
            const afterElement = getDragAfterElement(
              list,
              e.changedTouches[0].clientY
            );
            if (afterElement == null) {
              list.appendChild(li);
            } else {
              list.insertBefore(li, afterElement);
            }

            this.currentOrderState = [
              ...list.querySelectorAll(".draggable-item"),
            ].map((el) => el.dataset.value);
          });

          return li;
        };
        this.currentOrderState.forEach((item, idx) => {
          list.appendChild(createItem(item, idx));
        });
        const correctPanel = document.createElement("div");
        correctPanel.className =
          "space-y-4 hidden animate-fade-in pt-4 border-t border-dashed border-white/10";
        const correctTitle = document.createElement("h3");
        correctTitle.className =
          "text-lg font-semibold text-emerald-400 flex items-center gap-2";
        correctTitle.innerHTML = '<i class="ph ph-key"></i> ลำดับที่ถูกต้อง';
        correctPanel.appendChild(correctTitle);
        const orderList = document.createElement("ol");
        orderList.className = "space-y-2";
        q.items.forEach((item, index) => {
          const li = document.createElement("li");
          li.className =
            "flex items-center gap-3 p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/20 text-emerald-200";
          li.innerHTML = `<span class="text-sm font-bold text-emerald-400">${index + 1
            }.</span> ${item}`;
          orderList.appendChild(li);
        });
        correctPanel.appendChild(orderList);
        const container = document.createElement("div");
        container.className = "space-y-8";
        container.appendChild(list);
        container.appendChild(correctPanel);
        this.ui.content.appendChild(container);
        this.ui.submitArea.classList.remove("hidden");
        this.ui.submitBtn.onclick = async () => {
          this.ui.submitBtn.disabled = true;
          this.ui.submitBtn.classList.add("opacity-50", "cursor-not-allowed");
          const userOrder = this.currentOrderState;
          const correctOrder = q.items;
          const isCorrect =
            JSON.stringify(userOrder) === JSON.stringify(correctOrder);
          const listItems = Array.from(list.children);
          listItems.forEach((li, idx) => {
            const val = li.dataset.value;
            const isCorrectPosition = val === correctOrder[idx];
            li.classList.remove("bg-slate-800/50", "border-white/10");
            if (isCorrectPosition) {
              li.classList.add(
                "bg-emerald-500/20",
                "border-emerald-500/50",
                "text-emerald-200"
              );
            } else {
              li.classList.add(
                "bg-red-500/20",
                "border-red-500/50",
                "text-red-200"
              );
            }
          });
          if (!isCorrect) {
            const card = document.getElementById("question-card");
            card.classList.remove("animate-shake");
            void card.offsetWidth;
            card.classList.add("animate-shake");
            correctPanel.classList.remove("hidden");
            setTimeout(() => {
              correctPanel.scrollIntoView({
                behavior: "smooth",
                block: "nearest",
              });
            }, 100);
          }
          this.currentOrderState = null;
          this.handleAnswer(isCorrect, "");
        };
      }

      handleAnswer(isCorrect, correctAnswerText, options = {}) {
        if (!this.isAnswering) return;
        this.isAnswering = false;

        const inputs = this.ui.content.querySelectorAll("button, input, li");
        inputs.forEach((el) => {
          el.disabled = true;
          if (el.tagName === "LI") el.setAttribute("draggable", "false");
        });

        if (this.currentSelectedElement) {
          const selectedBtn = this.currentSelectedElement;
          if (isCorrect) {
            selectedBtn.classList.remove(
              "bg-slate-800/50",
              "border-white/10",
              "hover:bg-slate-700/50"
            );
            selectedBtn.classList.add(
              "bg-emerald-600",
              "border-emerald-400",
              "text-white",
              "shadow-lg",
              "shadow-emerald-500/20"
            );
          } else {
            selectedBtn.classList.remove(
              "bg-slate-800/50",
              "border-white/10",
              "hover:bg-slate-700/50"
            );
            selectedBtn.classList.add(
              "bg-red-500/20",
              "border-red-500/50",
              "text-red-200"
            );
            const allOptions = this.ui.content.querySelectorAll("button");
            allOptions.forEach((btn) => {
              if (btn.dataset.value === correctAnswerText) {
                btn.classList.remove(
                  "bg-slate-800/50",
                  "border-white/10",
                  "hover:bg-slate-700/50"
                );
                btn.classList.add(
                  "bg-emerald-600",
                  "border-emerald-400",
                  "text-white",
                  "shadow-lg",
                  "shadow-emerald-500/20"
                );
              }
            });
          }
        }

        if (isCorrect) {
          this.score++;
          this.ui.feedbackMsg.className =
            "mb-4 p-4 rounded-lg bg-emerald-500/10 border border-emerald-500/20 text-emerald-300 text-sm font-medium flex items-center gap-3 animate-fade-in";
          this.ui.feedbackMsg.innerHTML =
            '<i class="ph ph-check-circle text-xl"></i> <span>ถูกต้อง!</span>';
        } else {
          if (!options.skipShake) {
            document
              .getElementById("question-card")
              .classList.add("animate-shake");
          }
          this.ui.feedbackMsg.className =
            "mb-4 p-4 rounded-lg bg-red-500/10 border border-red-500/20 text-red-300 text-sm font-medium flex flex-col gap-1 animate-fade-in";
          const currentQuestion = this.questions[this.currentIndex];
          let feedbackHTML = `<div class="flex items-center gap-3"><i class="ph ph-x-circle text-xl"></i> <span>ผิด</span></div>`;
          if (
            currentQuestion.type !== "matching" &&
            currentQuestion.type !== "ordering"
          ) {
            feedbackHTML += `<div class="text-red-200/70 text-xs ml-8">คำตอบที่ถูกต้อง: <span class="text-white font-semibold">${correctAnswerText}</span></div>`;
          }
          this.ui.feedbackMsg.innerHTML = feedbackHTML;
        }

        this.ui.submitArea.classList.add("hidden");
        this.ui.feedbackArea.classList.remove("hidden");

        this.ui.nextBtn.onclick = () => {
          this.currentIndex++;
          this.saveProgress();
          this.renderQuestion();
        };
      }

      finishQuiz() {
        this.clearProgress();
        this.showScreen("results");

        document.getElementById("final-score").textContent = this.score;
        document.getElementById("total-questions").textContent =
          this.questions.length;

        const percent = Math.round(
          (this.score / this.questions.length) * 100
        );
        document.getElementById("final-percent").textContent = `${percent}%`;

        const iconContainer = document.getElementById("score-icon");
        if (percent >= 80) {
          iconContainer.className =
            "mb-6 inline-flex items-center justify-center w-20 h-20 rounded-full bg-emerald-500/10 text-emerald-400";
          iconContainer.innerHTML = '<i class="ph ph-trophy text-4xl"></i>';
        } else if (percent >= 50) {
          iconContainer.className =
            "mb-6 inline-flex items-center justify-center w-20 h-20 rounded-full bg-yellow-500/10 text-yellow-400";
          iconContainer.innerHTML = '<i class="ph ph-star text-4xl"></i>';
        } else {
          iconContainer.className =
            "mb-6 inline-flex items-center justify-center w-20 h-20 rounded-full bg-red-500/10 text-red-400";
          iconContainer.innerHTML =
            '<i class="ph ph-arrow-counter-clockwise text-4xl"></i>';
        }
      }
    }

    const quizApp = new QuizApp();
  </script>
</body>

</html>