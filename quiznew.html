<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hamlet Mastery: Final Fixed</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                fontFamily: { sans: ['Inter', 'sans-serif'] },
                extend: {
                    colors: {
                        background: '#050505',
                        surface: '#0A0A0A',
                        border: '#262626',
                        subtle: '#737373',
                        text: '#EDEDED',
                    },
                    animation: {
                        'enter': 'enter 0.3s ease-out forwards',
                        'slide-down': 'slideDown 0.3s ease-out forwards',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    },
                    keyframes: {
                        enter: { '0%': { opacity: '0', transform: 'scale(0.99)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        slideDown: { '0%': { opacity: '0', transform: 'translateY(-10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        pop: { '0%': { transform: 'scale(0.5)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        .glass {
            background: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid #262626;
        }

        .scroller::-webkit-scrollbar {
            width: 4px;
        }

        .scroller::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 99px;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .draggable-item {
            touch-action: none;
        }

        .draggable-item.dragging {
            background: rgba(59, 130, 246, 0.15) !important;
            border: 2px dashed #3b82f6 !important;
            opacity: 1 !important;
            box-shadow: none !important;
            color: transparent !important;
        }

        .draggable-item.dragging * {
            visibility: hidden !important;
        }

        .mobile-placeholder {
            background: rgba(59, 130, 246, 0.15);
            border: 2px dashed #3b82f6;
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
        }
    </style>
</head>

<body
    class="bg-background text-text h-screen w-full flex items-center justify-center overflow-hidden selection:bg-white selection:text-black">

    <div id="app"
        class="relative z-10 w-full max-w-3xl h-[90vh] max-h-[850px] glass rounded-2xl flex flex-col overflow-hidden shadow-2xl animate-enter">

        <div id="view-start" class="flex-1 flex flex-col items-center justify-center p-8 text-center">
            <div
                class="w-16 h-16 bg-white rounded-full flex items-center justify-center mb-6 shadow-xl shadow-white/10">
                <i class="ph-fill ph-book-open-text text-3xl text-black"></i>
            </div>
            <h1 class="text-3xl font-bold tracking-tight mb-2 text-white">Hamlet Quiz</h1>
            <p class="text-subtle mb-8">Fetching data from ./data/Hamlet.json</p>
            <button id="start-btn" onclick="quiz.init()"
                class="w-full max-w-xs h-12 bg-white text-black hover:bg-gray-200 rounded-md font-medium text-sm transition-all">Load
                & Start</button>
        </div>

        <div id="view-quiz" class="hidden flex-col h-full">
            <header class="h-16 border-b border-border flex items-center justify-between px-6 bg-surface/50 gap-4">
                <div class="flex items-center gap-4 shrink-0">
                    <button onclick="quiz.endSession()"
                        class="text-xs font-medium bg-red-500/10 hover:bg-red-500/20 text-red-400 px-3 py-1.5 rounded-lg border border-red-500/20 transition-colors"
                        title="End Session">
                        Finish
                    </button>
                    <div class="text-sm font-mono text-subtle font-medium border-l border-border pl-4">
                        <span id="lbl-count" class="text-white">1</span> <span class="opacity-50">/</span> <span
                            id="lbl-total">10</span>
                    </div>
                </div>
                <div id="nav-bubbles" class="flex-1 flex items-center justify-center gap-2 overflow-x-hidden py-2">
                </div>
                <div class="flex items-center gap-2 shrink-0">
                    <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div>
                    <span id="lbl-score" class="text-xs font-mono text-white">0</span>
                </div>
            </header>
            <main id="q-container" class="flex-1 overflow-y-auto scroller p-6 md:p-8 relative"></main>
            <footer id="global-footer"
                class="h-20 border-t border-border flex items-center justify-between px-6 bg-surface/50 backdrop-blur-md">
                <button id="btn-prev" onclick="quiz.prev()"
                    class="px-4 py-2 text-xs font-medium text-subtle hover:text-white disabled:opacity-30 transition-colors">Previous</button>
                <button id="btn-next"
                    class="h-9 px-6 bg-white text-black hover:bg-gray-200 rounded-md text-sm font-medium transition-colors shadow-lg shadow-white/5">Submit</button>
            </footer>
        </div>

        <div id="view-result" class="hidden flex-col h-full bg-background">
            <div class="flex-1 overflow-y-auto scroller">
                <div class="p-10 text-center border-b border-border bg-gradient-to-b from-surface to-background">
                    <h2 class="text-xl font-semibold text-white mb-2">Assessment Complete</h2>
                    <div
                        class="text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 mb-6">
                        <span id="res-score">0</span>%
                    </div>
                    <button onclick="quiz.restart()"
                        class="px-6 py-2 bg-white text-black hover:bg-gray-200 rounded-full text-xs font-medium transition-transform active:scale-95">Restart
                        (New Shuffle)</button>
                </div>
                <div class="p-6 max-w-xl mx-auto">
                    <h3 class="text-xs font-bold text-subtle uppercase tracking-widest mb-4">Click Card to Review</h3>
                    <div id="review-list" class="space-y-4 pb-12"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- EXPANDED COLOR PALETTE (No Green/Red) ---
        const COLORS = [
            { bg: "bg-blue-500/20", border: "border-blue-500/50", text: "text-blue-200" },
            { bg: "bg-indigo-500/20", border: "border-indigo-500/50", text: "text-indigo-200" },
            { bg: "bg-violet-500/20", border: "border-violet-500/50", text: "text-violet-200" },
            { bg: "bg-purple-500/20", border: "border-purple-500/50", text: "text-purple-200" },
            { bg: "bg-fuchsia-500/20", border: "border-fuchsia-500/50", text: "text-fuchsia-200" },
            { bg: "bg-pink-500/20", border: "border-pink-500/50", text: "text-pink-200" },
            { bg: "bg-sky-500/20", border: "border-sky-500/50", text: "text-sky-200" },
            { bg: "bg-cyan-500/20", border: "border-cyan-500/50", text: "text-cyan-200" },
            { bg: "bg-amber-500/20", border: "border-amber-500/50", text: "text-amber-200" },
            { bg: "bg-yellow-500/20", border: "border-yellow-500/50", text: "text-yellow-200" },
            { bg: "bg-slate-500/20", border: "border-slate-500/50", text: "text-slate-200" },
            { bg: "bg-zinc-500/20", border: "border-zinc-500/50", text: "text-zinc-200" },
            { bg: "bg-neutral-500/20", border: "border-neutral-500/50", text: "text-neutral-200" },
            { bg: "bg-stone-500/20", border: "border-stone-500/50", text: "text-stone-200" },
            { bg: "bg-blue-600/20", border: "border-blue-600/50", text: "text-blue-100" }, // Darker Blue
            { bg: "bg-indigo-600/20", border: "border-indigo-600/50", text: "text-indigo-100" }, // Darker Indigo
            { bg: "bg-purple-600/20", border: "border-purple-600/50", text: "text-purple-100" }, // Darker Purple
            { bg: "bg-pink-600/20", border: "border-pink-600/50", text: "text-pink-100" }, // Darker Pink
            { bg: "bg-sky-600/20", border: "border-sky-600/50", text: "text-sky-100" }, // Darker Sky
            { bg: "bg-teal-600/20", border: "border-teal-600/50", text: "text-teal-100" }, // Using Teal cautiously (Blue-ish)
            { bg: "bg-cyan-600/20", border: "border-cyan-600/50", text: "text-cyan-100" }, // Darker Cyan
            { bg: "bg-fuchsia-600/20", border: "border-fuchsia-600/50", text: "text-fuchsia-100" }, // Darker Fuchsia
            { bg: "bg-violet-600/20", border: "border-violet-600/50", text: "text-violet-100" }, // Darker Violet
            { bg: "bg-slate-400/20", border: "border-slate-400/50", text: "text-slate-300" } // Lighter Slate
        ];

        const formatAnswer = (val) => {
            if (val === true) return "True";
            if (val === false) return "False";
            return val;
        };

        const quiz = (() => {
            let RAW_DATA = [];
            let state = { q: [], idx: 0, ans: {}, score: 0, matchState: null, currentOrderState: null };

            const $ = (id) => document.getElementById(id);
            const els = {
                views: { start: $('view-start'), quiz: $('view-quiz'), result: $('view-result') },
                nav: $('nav-bubbles'), sc: $('lbl-score'),
                count: $('lbl-count'), total: $('lbl-total'),
                main: $('q-container'),
                footer: $('global-footer'), next: $('btn-next'), prev: $('btn-prev'),
                resScore: $('res-score'), revList: $('review-list'), startBtn: $('start-btn')
            };

            const shuffle = (a) => a.sort(() => Math.random() - 0.5);
            const switchView = (v) => {
                Object.values(els.views).forEach(e => { e.classList.add('hidden'); e.classList.remove('flex'); });
                els.views[v].classList.remove('hidden'); els.views[v].classList.add('flex');
            };

            const init = async () => {
                try {
                    els.startBtn.innerText = "Fetching Data...";
                    els.startBtn.disabled = true;
                    // FETCH FROM FILE
                    const response = await fetch('./data/Hamlet.json');
                    if (!response.ok) throw new Error("JSON not found");
                    RAW_DATA = await response.json();
                    startNewGame();
                } catch (e) {
                    console.error(e);
                    alert("Error: " + e.message + "\n\nUse a local server (e.g. Live Server) to fetch JSON files.");
                    els.startBtn.innerText = "Retry Load";
                    els.startBtn.disabled = false;
                }
            };

            const startNewGame = () => {
                state.q = shuffle(JSON.parse(JSON.stringify(RAW_DATA))).map(q => {
                    if (q.type === 'multiple_choice') q.options = shuffle(q.options);
                    if (q.type === 'ordering') q.shuffledItems = shuffle([...q.items]);
                    return q;
                });
                state.idx = 0; state.ans = {}; state.score = 0;
                state.matchState = null; state.currentOrderState = null;
                render();
            };

            const endSession = () => {
                if (confirm("Finish quiz now? Unanswered questions will be marked incorrect.")) {
                    finish();
                }
            };

            const reviewQuestion = (index) => {
                state.idx = index;
                state.matchState = null;
                state.currentOrderState = null;
                render();
            };

            const render = () => {
                switchView('quiz');
                els.sc.innerText = state.score;
                els.count.innerText = state.idx + 1;
                els.total.innerText = state.q.length;

                const q = state.q[state.idx];
                const isAns = state.ans[q.id] !== undefined;

                // --- 5+/- BUBBLE LOGIC ---
                els.nav.innerHTML = '';
                const range = 2;
                const startRange = Math.max(0, state.idx - range);
                const endRange = Math.min(state.q.length - 1, state.idx + range);

                if (startRange > 0) els.nav.appendChild(Object.assign(document.createElement('div'), { className: "text-subtle text-xs shrink-0", innerText: "•" }));

                for (let i = startRange; i <= endRange; i++) {
                    const btn = document.createElement('button');
                    const ansStat = state.ans[state.q[i].id];
                    let cls = "w-8 h-8 rounded-full text-xs font-medium shrink-0 flex items-center justify-center transition-all animate-pop ";
                    if (i === state.idx) cls += "bg-white text-black ring-4 ring-white/10 scale-110 shadow-lg z-10 font-bold";
                    else if (ansStat !== undefined) cls += check(state.q[i], ansStat) ? "bg-green-500 text-white" : "bg-red-500 text-white";
                    else cls += "bg-surface border border-border text-subtle opacity-50";
                    btn.className = cls; btn.innerText = i + 1;
                    if (ansStat !== undefined || i < state.idx) {
                        btn.onclick = () => { state.idx = i; state.matchState = null; state.currentOrderState = null; render(); };
                    } else btn.classList.add('cursor-default');
                    els.nav.appendChild(btn);
                }

                if (endRange < state.q.length - 1) els.nav.appendChild(Object.assign(document.createElement('div'), { className: "text-subtle text-xs shrink-0", innerText: "•" }));

                els.main.innerHTML = '';
                const wrapper = document.createElement('div');
                wrapper.className = 'animate-enter max-w-4xl mx-auto';
                wrapper.id = 'question-card';
                wrapper.innerHTML = `<h2 class="text-xl font-medium text-white mb-6 leading-relaxed">${q.question}</h2>`;

                const contentArea = document.createElement('div');
                contentArea.className = "w-full";

                if (q.type === 'matching') {
                    els.footer.classList.add('hidden');
                    renderMatching(q, contentArea, isAns);
                } else {
                    els.footer.classList.remove('hidden');
                    if (q.type === 'ordering') renderOrdering(q, contentArea, isAns);
                    else renderStandard(q, contentArea, isAns);
                    setupGlobalFooter(q, isAns);
                }

                wrapper.appendChild(contentArea);
                els.main.appendChild(wrapper);
            };

            const setupGlobalFooter = (q, isAns) => {
                els.prev.disabled = state.idx === 0;
                if (!isAns) {
                    els.next.innerText = "Submit";
                    els.next.className = "h-9 px-6 bg-white text-black hover:bg-gray-200 rounded-md text-sm font-medium shadow-lg shadow-white/5";
                    if (q.type === 'ordering') els.next.onclick = () => submitOrdering(q);
                    else els.next.onclick = () => submitStandard(q);
                } else {
                    els.next.innerText = (state.idx === state.q.length - 1) ? "Finish" : "Next";
                    els.next.className = "h-9 px-6 bg-surface border border-border hover:bg-white/10 text-white rounded-md text-sm font-medium";
                    els.next.onclick = (state.idx === state.q.length - 1) ? finish : next;
                }
            };

            // --- MATCHING ---
            const renderMatching = (q, container, isAns) => {
                if (!state.matchState) {
                    const lefts = q.pairs.map((p, i) => ({ text: p.left, id: i }));
                    const rights = q.pairs.map((p, i) => ({ text: p.right, id: i }));
                    state.matchState = {
                        leftItems: shuffle(lefts),
                        rightItems: shuffle(rights),
                        userPairs: isAns ? state.ans[q.id] : [],
                        selectedLeft: null
                    };
                }
                const { leftItems, rightItems } = state.matchState;
                const grid = document.createElement("div"); grid.className = "space-y-8";
                const cols = document.createElement("div");
                cols.className = "grid grid-cols-2 gap-4 md:gap-12 relative";
                if (!isAns) cols.innerHTML += `<div class="absolute left-1/2 top-0 bottom-0 w-px bg-white/5 -translate-x-1/2 hidden md:block"></div>`;

                const createCol = (items, isLeft) => {
                    const col = document.createElement("div"); col.className = "flex flex-col gap-3";
                    items.forEach(item => {
                        const btn = document.createElement("button");
                        btn.className = "w-full p-4 text-sm rounded-xl border text-left transition-all duration-200";
                        btn.dataset.id = item.id; btn.innerText = item.text;
                        col.appendChild(btn);
                    });
                    return col;
                };

                const leftDOM = createCol(leftItems, true);
                const rightDOM = createCol(rightItems, false);
                cols.appendChild(leftDOM); cols.appendChild(rightDOM); grid.appendChild(cols);

                const actions = document.createElement("div"); actions.className = "mt-8 pt-4 border-t border-white/5";
                if (!isAns) {
                    actions.innerHTML = `<div class="flex gap-3"><button id="match-reset" class="px-6 py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-lg font-medium transition-colors border border-white/10">Reset</button><button id="match-submit" class="flex-1 py-3 bg-white text-black hover:bg-gray-200 rounded-lg font-medium transition-colors shadow-lg shadow-white/10">Submit Answer</button></div>`;
                } else {
                    const txt = (state.idx === state.q.length - 1) ? "Finish" : "Next Question";
                    actions.innerHTML = `<button id="match-next" class="w-full py-3 bg-surface border border-border hover:bg-white/10 text-white rounded-lg font-medium transition-colors">${txt}</button>`;
                }
                grid.appendChild(actions);

                if (isAns && !check(q, state.ans[q.id])) {
                    const correction = document.createElement("div");
                    correction.className = "mt-6 animate-fade-in space-y-4";
                    correction.innerHTML = `<h3 class="text-emerald-400 font-bold uppercase text-xs tracking-wider flex items-center gap-2"><i class="ph-fill ph-key"></i> Correct Pairs</h3><div class="grid grid-cols-2 gap-4 md:gap-12 relative"><div class="absolute left-1/2 top-0 bottom-0 w-px bg-white/5 -translate-x-1/2 hidden md:block"></div><div class="flex flex-col gap-3" id="corr-left"></div><div class="flex flex-col gap-3" id="corr-right"></div></div>`;
                    grid.appendChild(correction);
                    setTimeout(() => {
                        const lC = correction.querySelector('#corr-left'); const rC = correction.querySelector('#corr-right');
                        leftItems.forEach(leftItem => {
                            const c = COLORS[leftItem.id % COLORS.length];
                            const style = `w-full p-4 text-sm rounded-xl border text-left ${c.bg} ${c.border} ${c.text}`;
                            lC.innerHTML += `<div class="${style}">${leftItem.text}</div>`;
                            rC.innerHTML += `<div class="${style}">${q.pairs[leftItem.id].right}</div>`;
                        });
                    }, 0);
                }
                container.appendChild(grid);

                if (!isAns) {
                    Array.from(leftDOM.children).forEach((btn, i) => btn.onclick = () => handleMatchClick(leftItems[i], true, q, leftDOM, rightDOM));
                    Array.from(rightDOM.children).forEach((btn, i) => btn.onclick = () => handleMatchClick(rightItems[i], false, q, leftDOM, rightDOM));
                }
                updateMatchStyles(leftDOM, rightDOM, isAns, q);

                setTimeout(() => {
                    if (!isAns) {
                        $('match-reset').onclick = () => { state.matchState.userPairs = []; state.matchState.selectedLeft = null; updateMatchStyles(leftDOM, rightDOM, false, q); };
                        $('match-submit').onclick = () => {
                            if (state.matchState.userPairs.length < leftItems.length) { $('question-card').classList.add('animate-shake'); setTimeout(() => $('question-card').classList.remove('animate-shake'), 500); return; }
                            let correct = 0; state.matchState.userPairs.forEach(p => { if (p.leftId === p.rightId) correct++; });
                            if (correct === leftItems.length) state.score++; state.ans[q.id] = state.matchState.userPairs; render();
                        };
                    } else { $('match-next').onclick = (state.idx === state.q.length - 1) ? finish : next; }
                }, 0);
            };

            const handleMatchClick = (item, isLeft, q, lDOM, rDOM) => {
                const ms = state.matchState;
                if (isLeft) {
                    if (!ms.userPairs.some(p => p.leftId === item.id)) { ms.selectedLeft = item; updateMatchStyles(lDOM, rDOM, false, q); }
                } else {
                    if (!ms.userPairs.some(p => p.rightId === item.id) && ms.selectedLeft) {
                        ms.userPairs.push({ leftId: ms.selectedLeft.id, rightId: item.id }); ms.selectedLeft = null; updateMatchStyles(lDOM, rDOM, false, q);
                    }
                }
            };

            const updateMatchStyles = (lDOM, rDOM, isAns, q) => {
                const ms = state.matchState;
                const applyStyle = (btn, isLeft) => {
                    const id = parseInt(btn.dataset.id);
                    const pair = ms.userPairs.find(p => isLeft ? p.leftId === id : p.rightId === id);
                    btn.className = "w-full p-4 text-sm rounded-xl border text-left transition-all duration-200 ";
                    if (pair) {
                        const c = COLORS[pair.leftId % COLORS.length];
                        if (isAns) {
                            const correct = pair.leftId === pair.rightId;
                            btn.className += correct ? `${c.bg} ${c.border} ${c.text} ring-1 ring-emerald-500` : `bg-red-500/10 border-red-500/50 text-red-200`;
                            btn.innerHTML = btn.innerText.split('<')[0] + (correct ? ` <i class="ph-bold ph-check float-right mt-1 text-lg text-emerald-400 animate-pop"></i>` : ``);
                        } else btn.className += `${c.bg} ${c.border} ${c.text}`;
                    } else if (isLeft && ms.selectedLeft && ms.selectedLeft.id === id) {
                        btn.className += "bg-indigo-600 border-indigo-400 text-white ring-2 ring-indigo-400/50 scale-[1.02] shadow-lg";
                    } else {
                        btn.className += "bg-surface border-border text-subtle hover:text-white hover:border-white/20";
                        if (isAns) btn.className += " opacity-30";
                    }
                };
                Array.from(lDOM.children).forEach(b => applyStyle(b, true));
                Array.from(rDOM.children).forEach(b => applyStyle(b, false));
            };

            // --- STANDARD (MC/TF/Short Answer) ---
            const renderStandard = (q, container, isAns) => {
                const inputArea = document.createElement('div'); inputArea.className = 'space-y-3'; inputArea.id = 'std-inputs';

                if (q.type === 'short_answer') {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = "w-full p-4 rounded-lg bg-surface border border-border text-white focus:outline-none focus:border-white transition-colors";
                    input.placeholder = "Type your answer here...";

                    if (isAns) {
                        input.value = state.ans[q.id] || ""; // FIXED: Ensure wrong answer stays
                        input.disabled = true;
                        const correct = check(q, state.ans[q.id]);
                        input.className = correct ? "w-full p-4 rounded-lg bg-green-500/10 border border-green-500 text-green-200" : "w-full p-4 rounded-lg bg-red-500/10 border border-red-500 text-red-200";
                    }
                    inputArea.appendChild(input);
                } else {
                    const baseStyle = "w-full text-left p-4 rounded-lg border text-sm transition-all border-border bg-surface/50 hover:border-white/50 hover:bg-surface text-subtle hover:text-white";
                    const activeStyle = "w-full text-left p-4 rounded-lg border text-sm transition-all border-white bg-white text-black font-medium shadow-lg";

                    (q.type === 'true_false' ? ['True', 'False'] : q.options).forEach(opt => {
                        const btn = document.createElement('button');
                        const val = (q.type === 'true_false') ? (opt === 'True') : opt;
                        if (!isAns) {
                            btn.className = baseStyle;
                            btn.onclick = () => {
                                inputArea.querySelectorAll('button').forEach(b => b.className = baseStyle);
                                btn.className = activeStyle; btn.dataset.val = JSON.stringify(val);
                            };
                        } else {
                            const selected = state.ans[q.id] === val; const correct = q.correct === val;
                            let cls = "w-full text-left p-4 rounded-lg border text-sm transition-all ";
                            if (selected) cls += correct ? "border-green-500 bg-green-500/10 text-white" : "border-red-500 bg-red-500/10 text-white";
                            else if (correct) cls += "border-green-500/30 text-green-500 opacity-60"; else cls += "border-border opacity-20";
                            btn.className = cls;
                        }
                        btn.innerText = opt; inputArea.appendChild(btn);
                    });
                }
                container.appendChild(inputArea);

                if (isAns && !check(q, state.ans[q.id])) {
                    container.innerHTML += `<div class="mt-4 p-4 bg-red-500/5 border border-red-500/10 rounded-lg animate-slide-down"><div class="text-xs font-bold text-red-400 uppercase mb-1">Incorrect</div><div class="text-sm text-subtle">Correct Answer: <span class="text-white">${formatAnswer(q.correct)}</span></div></div>`;
                }
            };

            const submitStandard = (q) => {
                let ans = null;
                if (q.type === 'short_answer') {
                    const input = document.querySelector('#std-inputs input');
                    if (input && input.value.trim() !== '') ans = input.value.trim();
                } else {
                    const sel = document.querySelector('#std-inputs button[data-val]');
                    if (sel) ans = JSON.parse(sel.dataset.val);
                }
                if (ans === null) return;
                if (check(q, ans)) state.score++; state.ans[q.id] = ans; render();
            };

            // --- ORDERING ---
            const renderOrdering = (q, container, isAns) => {
                if (!state.currentOrderState) state.currentOrderState = isAns ? state.ans[q.id] : [...q.shuffledItems];
                const list = document.createElement("ul"); list.className = "flex flex-col gap-3 relative";
                const placeholder = document.createElement("div"); placeholder.className = "mobile-placeholder h-[60px] hidden";

                const getDragAfterElement = (container, y) => {
                    const draggables = [...container.querySelectorAll(".draggable-item:not(.dragging)")];
                    return draggables.reduce((closest, child) => {
                        const box = child.getBoundingClientRect();
                        const offset = y - box.top - box.height / 2;
                        return (offset < 0 && offset > closest.offset) ? { offset, element: child } : closest;
                    }, { offset: Number.NEGATIVE_INFINITY }).element;
                };

                list.addEventListener("dragover", e => {
                    if (isAns) return; e.preventDefault();
                    const after = getDragAfterElement(list, e.clientY);
                    const drag = document.querySelector(".dragging");
                    if (drag) after == null ? list.appendChild(drag) : list.insertBefore(drag, after);
                });

                state.currentOrderState.forEach((item, index) => {
                    const li = document.createElement("li");
                    let base = "draggable-item flex items-center gap-4 p-4 rounded-xl border transition-colors group select-none ";
                    if (isAns) base += (item === q.items[index]) ? "bg-green-500/10 border-green-500/50 text-green-200" : "bg-red-500/10 border-red-500/50 text-red-200";
                    else base += "bg-surface border-border hover:border-blue-500/50 cursor-grab active:cursor-grabbing";
                    li.className = base;
                    li.setAttribute("draggable", !isAns);
                    li.dataset.value = item;
                    li.innerHTML = `<div class="p-1 pointer-events-none ${isAns ? 'opacity-50' : 'text-subtle'}"><i class="ph ph-dots-six-vertical text-xl"></i></div><span class="flex-grow font-medium pointer-events-none">${item}</span>`;

                    if (!isAns) {
                        li.addEventListener("dragstart", () => li.classList.add("dragging"));
                        li.addEventListener("dragend", () => {
                            li.classList.remove("dragging");
                            state.currentOrderState = [...list.querySelectorAll(".draggable-item")].map(el => el.dataset.value);
                        });
                        li.addEventListener("touchstart", (e) => {
                            e.preventDefault(); const t = e.touches[0]; const r = li.getBoundingClientRect();
                            placeholder.style.height = `${r.height}px`; placeholder.classList.remove('hidden'); li.parentNode.insertBefore(placeholder, li);
                            li.style.position = 'fixed'; li.style.width = `${r.width}px`; li.style.left = `${r.left}px`; li.style.top = `${r.top}px`; li.style.zIndex = 1000; li.style.background = '#0A0A0A'; li.style.border = '1px solid #3b82f6'; li.classList.add('dragging-mobile');
                            li.dataset.startX = t.clientX; li.dataset.startY = t.clientY; li.dataset.rectX = r.left; li.dataset.rectY = r.top;
                        });
                        li.addEventListener("touchmove", (e) => {
                            e.preventDefault(); const t = e.touches[0];
                            li.style.left = `${parseFloat(li.dataset.rectX) + (t.clientX - parseFloat(li.dataset.startX))}px`;
                            li.style.top = `${parseFloat(li.dataset.rectY) + (t.clientY - parseFloat(li.dataset.startY))}px`;
                            const after = getDragAfterElement(list, t.clientY);
                            if (after == null) list.appendChild(placeholder); else list.insertBefore(placeholder, after);
                        });
                        li.addEventListener("touchend", (e) => {
                            li.style.position = ''; li.style.width = ''; li.style.left = ''; li.style.top = ''; li.style.zIndex = ''; li.style.background = ''; li.style.border = ''; li.classList.remove('dragging-mobile');
                            placeholder.classList.add('hidden'); if (placeholder.parentNode) placeholder.parentNode.removeChild(placeholder);
                            const after = getDragAfterElement(list, e.changedTouches[0].clientY);
                            if (after == null) list.appendChild(li); else list.insertBefore(li, after);
                            state.currentOrderState = [...list.querySelectorAll(".draggable-item")].map(el => el.dataset.value);
                        });
                    }
                    list.appendChild(li);
                });
                container.appendChild(list);

                if (isAns && !check(q, state.ans[q.id])) container.innerHTML += `<div class="mt-4 pt-4 border-t border-dashed border-white/10 animate-fade-in"><h3 class="text-sm font-bold text-green-400 uppercase tracking-wider mb-2">Correct Sequence</h3><ol class="space-y-2">${q.items.map((item, i) => `<li class="flex items-center gap-3 p-3 rounded-lg bg-green-500/5 border border-green-500/10 text-green-200 text-sm"><span class="font-bold text-green-500">${i + 1}.</span> ${item}</li>`).join('')}</ol></div>`;
            };

            const submitOrdering = (q) => {
                const userOrder = state.currentOrderState;
                if (JSON.stringify(userOrder) === JSON.stringify(q.items)) state.score++;
                else { $('question-card').classList.add('animate-shake'); setTimeout(() => $('question-card').classList.remove('animate-shake'), 500); }
                state.ans[q.id] = userOrder; render();
            };

            const check = (q, ans) => {
                if (q.type === 'matching') { if (!ans) return false; let c = 0; ans.forEach(p => { if (p.leftId === p.rightId) c++; }); return c === q.pairs.length; }
                if (q.type === 'ordering') return JSON.stringify(ans) === JSON.stringify(q.items);
                if (q.type === 'short_answer') return ans.trim().toLowerCase() === q.correct.toLowerCase();
                return ans === q.correct;
            };

            const next = () => { state.idx++; state.matchState = null; state.currentOrderState = null; render(); };

            const finish = () => {
                switchView('result');
                els.resScore.innerText = Math.round((state.score / state.q.length) * 100);
                els.revList.innerHTML = '';
                state.q.forEach((q, i) => {
                    const ans = state.ans[q.id];
                    const isCorrect = check(q, ans);
                    const card = document.createElement('div');
                    card.onclick = () => reviewQuestion(i);
                    card.className = `p-4 border border-border rounded-xl cursor-pointer transition-all hover:bg-white/5 ${isCorrect ? 'bg-green-500/5' : 'bg-red-500/5'}`;

                    let correction = "";
                    if (!isCorrect) {
                        if (q.type === 'matching') {
                            correction = `<div class="mt-3 grid grid-cols-2 gap-2">${q.pairs.map((p, idx) => {
                                const c = COLORS[idx % COLORS.length];
                                return `<div class="p-2 rounded border ${c.bg} ${c.border} ${c.text} text-xs">${p.left}</div><div class="p-2 rounded border ${c.bg} ${c.border} ${c.text} text-xs">${p.right}</div>`;
                            }).join('')}</div>`;
                        } else if (q.type === 'ordering') {
                            correction = `<div class="mt-3 space-y-1">${q.items.map((it, idx) => `<div class="flex items-center gap-2 p-2 rounded bg-green-500/10 border border-green-500/20 text-xs text-green-200"><span class="font-bold">${idx + 1}.</span> ${it}</div>`).join('')}</div>`;
                        } else {
                            correction = `<div class="mt-2 text-sm text-subtle">Correct: <span class="text-white font-medium">${formatAnswer(q.correct)}</span></div>`;
                        }
                    }

                    card.innerHTML = `<div class="flex items-start gap-3"><div class="${isCorrect ? 'text-green-500' : 'text-red-500'} mt-0.5"><i class="ph-fill ${isCorrect ? 'ph-check-circle' : 'ph-x-circle'} text-lg"></i></div><div class="w-full"><div class="text-xs text-subtle mb-1">Question ${i + 1}</div><div class="text-sm font-medium text-white">${q.question}</div>${correction}</div></div>`;
                    els.revList.appendChild(card);
                });
            };

            return { init, start: startNewGame, quit: () => location.reload(), prev: () => { state.idx--; state.matchState = null; state.currentOrderState = null; render(); }, restart: startNewGame, endSession };
        })();
    </script>
</body>

</html>