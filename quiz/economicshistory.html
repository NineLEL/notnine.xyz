<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <link
      rel="icon"
      type="image/png"
      href="../public/favicon-96x96.png"
      sizes="96x96"
    />
    <link rel="icon" type="image/svg+xml" href="../public/favicon.svg" />
    <link rel="shortcut icon" href="../public/favicon.ico" />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="../public/apple-touch-icon.png"
    />
    <meta name="apple-mobile-web-app-title" content="Nine" />
    <link rel="manifest" href="../public/site.webmanifest" />
    <title>Economics History Quiz</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Sarabun:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          fontFamily: { sans: ["Sarabun", "sans-serif"] },
          extend: {
            colors: {
              background: "#050505",
              surface: "#0A0A0A",
              border: "#262626",
              subtle: "#737373",
              text: "#EDEDED",
            },
            animation: {
              enter: "enter 0.3s ease-out forwards",
              "slide-down": "slideDown 0.3s ease-out forwards",
              shake: "shake 0.5s cubic-bezier(.36,.07,.19,.97) both",
              pop: "pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)",
            },
            keyframes: {
              enter: {
                "0%": { opacity: "0", transform: "scale(0.99)" },
                "100%": { opacity: "1", transform: "scale(1)" },
              },
              slideDown: {
                "0%": { opacity: "0", transform: "translateY(-10px)" },
                "100%": { opacity: "1", transform: "translateY(0)" },
              },
              pop: {
                "0%": { transform: "scale(0.5)", opacity: "0" },
                "100%": { transform: "scale(1)", opacity: "1" },
              },
              shake: {
                "10%, 90%": { transform: "translate3d(-1px, 0, 0)" },
                "20%, 80%": { transform: "translate3d(2px, 0, 0)" },
                "30%, 50%, 70%": { transform: "translate3d(-4px, 0, 0)" },
                "40%, 60%": { transform: "translate3d(4px, 0, 0)" },
              },
            },
          },
        },
      };
    </script>

    <style>
      /* Mobile touch optimization */
      button {
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
      }

      .glass {
        background: rgba(10, 10, 10, 0.95);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid #262626;
      }

      .scroller {
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      .scroller::-webkit-scrollbar {
        width: 4px;
      }

      .scroller::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 99px;
      }

      .animate-enter,
      .animate-pop,
      .draggable-item {
        will-change: transform, opacity;
      }

      .draggable-item {
        touch-action: none;
        user-select: none;
        -webkit-user-select: none;
      }

      .draggable-item.dragging {
        background: rgba(59, 130, 246, 0.1) !important;
        border: 2px dashed #3b82f6 !important;
        opacity: 0.5 !important;
        box-shadow: none !important;
      }

      .draggable-item.dragging > * {
        opacity: 0 !important;
      }

      .draggable-item.dragging-mobile {
        position: fixed;
        z-index: 9999;
        background: #171717 !important;
        border: 1px solid #3b82f6 !important;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.8),
          0 8px 10px -6px rgba(0, 0, 0, 0.8);
        opacity: 0.95;
        pointer-events: none;
      }

      .mobile-placeholder {
        background: rgba(59, 130, 246, 0.15);
        border: 2px dashed #3b82f6;
        border-radius: 0.75rem;
        margin-bottom: 0.75rem;
      }
    </style>
  </head>

  <body
    class="bg-background text-text h-[100dvh] w-full flex items-center justify-center overflow-hidden selection:bg-white selection:text-black p-2 md:p-4"
  >
    <div
      id="app"
      class="relative z-10 w-full max-w-3xl h-full max-h-[90dvh] glass rounded-2xl flex flex-col overflow-hidden shadow-2xl animate-enter"
    >
      <div
        id="view-start"
        class="flex-1 flex flex-col items-center justify-center p-6 text-center"
      >
        <div
          class="w-16 h-16 bg-white rounded-full flex items-center justify-center mb-6 shadow-xl shadow-white/10"
        >
          <i class="ph-fill ph-book-open-text text-3xl text-black"></i>
        </div>
        <h1
          class="text-2xl md:text-3xl font-bold tracking-tight mb-2 text-white"
        >
          Economic History
        </h1>
        <p class="text-subtle mb-5 text-sm md:text-base">
          This quiz has a total of
          <span id="total-questions" class="font-bold">25</span> questions as of
          now.
        </p>
        <button
          id="start-btn"
          onclick="quiz.init()"
          class="w-full max-w-xs h-12 bg-white text-black hover:bg-gray-200 rounded-lg font-bold text-sm transition-transform active:scale-95"
        >
          Load & Start
        </button>
      </div>

      <div id="view-quiz" class="hidden flex-col h-full">
        <header
          class="h-14 md:h-16 border-b border-border flex items-center justify-between px-4 md:px-6 bg-surface/50 gap-2 md:gap-4 shrink-0"
        >
          <div class="flex items-center gap-3 shrink-0">
            <button
              id="btn-finish-header"
              onclick="quiz.endSession()"
              class="text-xs font-medium bg-red-500/10 hover:bg-red-500/20 text-red-400 px-3 py-1.5 rounded-lg border border-red-500/20 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              title="End Session"
            >
              Finish
            </button>
            <div
              class="text-xs md:text-sm font-mono text-subtle font-medium border-l border-border pl-3 md:pl-4"
            >
              <span id="lbl-count" class="text-white">1</span>
              <span class="opacity-50">/</span> <span id="lbl-total">10</span>
            </div>
          </div>
          <div
            id="nav-bubbles"
            class="flex-1 flex items-center justify-center gap-1.5 md:gap-2 overflow-hidden py-2"
          ></div>
          <div class="flex items-center gap-2 shrink-0">
            <div
              class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"
            ></div>
            <span id="lbl-score" class="text-xs font-mono text-white">0</span>
          </div>
        </header>

        <main
          id="q-container"
          class="flex-1 overflow-y-auto scroller p-4 md:p-8 relative w-full"
        ></main>

        <footer
          id="global-footer"
          class="h-16 md:h-20 border-t border-border flex items-center justify-between px-4 md:px-6 bg-surface/50 backdrop-blur-md shrink-0"
        >
          <button
            id="btn-prev"
            onclick="quiz.prev()"
            class="px-4 py-2 text-xs font-medium text-subtle hover:text-white disabled:opacity-30 transition-colors"
          >
            Previous
          </button>
          <button
            id="btn-next"
            class="h-10 px-6 bg-white text-black hover:bg-gray-200 rounded-lg text-sm font-bold transition-transform active:scale-95 shadow-lg shadow-white/5"
          >
            Submit
          </button>
        </footer>
      </div>

      <div id="view-result" class="hidden flex-col h-full bg-background z-20">
        <div class="flex-1 overflow-y-auto scroller w-full">
          <div
            class="p-8 md:p-10 text-center border-b border-border bg-gradient-to-b from-surface to-background"
          >
            <h2 class="text-lg md:text-xl font-semibold text-white mb-2">
              Assessment Complete
            </h2>
            <div
              class="text-5xl md:text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 mb-6"
            >
              <span id="res-score">0</span>%
            </div>
            <button
              onclick="quiz.restart()"
              class="px-6 py-2 bg-white text-black hover:bg-gray-200 rounded-full text-xs font-bold transition-transform active:scale-95"
            >
              Restart (New Shuffle)
            </button>
          </div>
          <div class="p-4 md:p-6 max-w-xl mx-auto w-full">
            <h3
              class="text-xs font-bold text-subtle uppercase tracking-widest mb-4"
            >
              Review Answered Questions
            </h3>
            <div id="review-list" class="space-y-3 pb-12 w-full"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const COLORS = [
        {
          bg: "bg-blue-500/20",
          border: "border-blue-500/50",
          text: "text-blue-200",
        },
        {
          bg: "bg-purple-500/20",
          border: "border-purple-500/50",
          text: "text-purple-200",
        },
        {
          bg: "bg-fuchsia-500/20",
          border: "border-fuchsia-500/50",
          text: "text-fuchsia-200",
        },
        {
          bg: "bg-cyan-500/20",
          border: "border-cyan-500/50",
          text: "text-cyan-200",
        },
        {
          bg: "bg-amber-500/20",
          border: "border-amber-500/50",
          text: "text-amber-200",
        },
        {
          bg: "bg-emerald-500/20",
          border: "border-emerald-500/50",
          text: "text-emerald-200",
        },
        {
          bg: "bg-rose-500/20",
          border: "border-rose-500/50",
          text: "text-rose-200",
        },
        {
          bg: "bg-indigo-500/20",
          border: "border-indigo-500/50",
          text: "text-indigo-200",
        },
      ];

      const formatAnswer = (val) =>
        val === true ? "True" : val === false ? "False" : val;
      const STORAGE_KEY = "eco_history_save_v1";

      const quiz = (() => {
        let RAW_DATA = [];
        let state = {
          q: [],
          idx: 0,
          ans: {},
          score: 0,
          matchState: null,
          currentOrderState: null,
          finished: false,
          hasAnswered: false,
        };

        const $ = (id) => document.getElementById(id);
        const els = {
          views: {
            start: $("view-start"),
            quiz: $("view-quiz"),
            result: $("view-result"),
          },
          nav: $("nav-bubbles"),
          sc: $("lbl-score"),
          count: $("lbl-count"),
          total: $("lbl-total"),
          main: $("q-container"),
          footer: $("global-footer"),
          next: $("btn-next"),
          prev: $("btn-prev"),
          resScore: $("res-score"),
          revList: $("review-list"),
          startBtn: $("start-btn"),
          finishBtn: $("btn-finish-header"),
        };

        const shuffle = (a) => a.sort(() => Math.random() - 0.5);

        const switchView = (v) => {
          Object.values(els.views).forEach((e) => {
            e.classList.add("hidden");
            e.classList.remove("flex");
          });
          els.views[v].classList.remove("hidden");
          els.views[v].classList.add("flex");
        };

        const saveProgress = () => {
          if (!state.hasAnswered) return;
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
          } catch (e) {
            console.error("Save failed", e);
          }
        };

        const clearProgress = () => {
          localStorage.removeItem(STORAGE_KEY);
        };

        const generateMatchingCorrectionHTML = (q) => {
          try {
            const itemsHTML = q.leftOrder
              .map((idx) => {
                const p = q.pairs[idx];
                const c = COLORS[idx % COLORS.length];
                const commonClass = `p-3 rounded-xl border text-xs md:text-sm font-medium ${c.bg} ${c.border} ${c.text} break-words flex items-center min-h-[48px]`;
                return `<div class="${commonClass}">${p.left}</div><div class="${commonClass}">${p.right}</div>`;
              })
              .join("");

            return `
                    <div class="mt-4 border-t border-white/5 pt-4">
                        <div class="grid grid-cols-2 gap-x-2 gap-y-2 md:gap-x-4 md:gap-y-3 relative">
                            <div class="absolute left-1/2 top-0 bottom-0 w-px bg-white/5 -translate-x-1/2 hidden md:block"></div>
                            ${itemsHTML}
                        </div>
                    </div>`;
          } catch (e) {
            return `<div class="text-red-500 text-xs">Error</div>`;
          }
        };

        const init = async () => {
          document.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              if (
                !els.views.start.classList.contains("hidden") &&
                !els.startBtn.disabled
              ) {
                els.startBtn.click();
                return;
              }
              if (!els.views.quiz.classList.contains("hidden")) {
                const mNext = document.getElementById("match-next");
                const mSubmit = document.getElementById("match-submit");
                if (mNext) {
                  mNext.click();
                  return;
                }
                if (mSubmit) {
                  mSubmit.click();
                  return;
                }
                // Only trigger the main footer if it's visible (avoid double submission)
                if (!els.footer.classList.contains("hidden")) {
                    // Manually dispatch a click to trigger the robust listener in setupGlobalFooter
                    els.next.dispatchEvent(new Event('click'));
                }
              }
            }
          });

          try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
              state = JSON.parse(saved);
              state.hasAnswered = Object.keys(state.ans).length > 0;
              if (state.finished) {
                restart();
              } else if (!state.ans[state.q[0].id]) {
                startNewGame();
              } else {
                render();
              }
              return;
            }
          } catch (e) {
            console.error("Load failed", e);
            clearProgress();
          }

          try {
            els.startBtn.innerText = "Loading...";
            els.startBtn.disabled = true;
            const response = await fetch("/data/EcoHistory.json");
            if (!response.ok) throw new Error("File not found");
            RAW_DATA = await response.json();
            startNewGame();
          } catch (e) {
            console.error(e);
            alert(
              "Error: " + e.message + "\nPlease run this on a local server."
            );
            els.startBtn.innerText = "Retry";
            els.startBtn.disabled = false;
          }
        };

        const startNewGame = () => {
          const dataWithIds = JSON.parse(JSON.stringify(RAW_DATA)).map(
            (q, i) => {
              if (!q.id) q.id = `q_${i}_${Date.now()}`;
              return q;
            }
          );

          state.q = shuffle(dataWithIds).map((q) => {
            if (q.type === "multiple_choice") q.options = shuffle(q.options);
            if (q.type === "ordering") q.shuffledItems = shuffle([...q.items]);
            if (q.type === "matching") {
              q.leftOrder = shuffle([...Array(q.pairs.length).keys()]);
            }
            return q;
          });
          state.idx = 0;
          state.ans = {};
          state.score = 0;
          state.matchState = null;
          state.currentOrderState = null;
          state.finished = false;
          state.hasAnswered = false;
          render();
        };

        const endSession = () => {
          if (Object.keys(state.ans).length === 0) return;
          if (confirm("Finish quiz now?")) finish();
        };

        const restart = () => {
          clearProgress();
          startNewGame();
        };

        const reviewQuestion = (index) => {
          state.idx = index;
          state.matchState = null;
          state.currentOrderState = null;
          switchView("quiz");
          render();
        };

        const render = () => {
          switchView("quiz");
          els.sc.innerText = state.score;
          els.count.innerText = state.idx + 1;
          els.total.innerText = state.q.length;

          const answeredCount = Object.keys(state.ans).length;
          els.finishBtn.disabled = answeredCount === 0;

          const q = state.q[state.idx];
          const isAns = state.ans[q.id] !== undefined;

          els.nav.innerHTML = "";
          const navFrag = document.createDocumentFragment();
          const range = 3;
          const startRange = Math.max(0, state.idx - range);
          const endRange = Math.min(state.q.length - 1, state.idx + range);

          if (startRange > 0) {
            const dot = document.createElement("div");
            dot.className = "text-subtle text-xs shrink-0";
            dot.innerText = "•";
            navFrag.appendChild(dot);
          }

          for (let i = startRange; i <= endRange; i++) {
            const btn = document.createElement("button");
            const ansStat = state.ans[state.q[i].id];
            let cls =
              "w-7 h-7 md:w-8 md:h-8 rounded-full text-[10px] md:text-xs font-medium shrink-0 flex items-center justify-center transition-all animate-pop ";

            if (i === state.idx)
              cls +=
                "bg-white text-black ring-4 ring-white/10 scale-110 shadow-lg z-10 font-bold";
            else if (ansStat !== undefined)
              cls += check(state.q[i], ansStat)
                ? "bg-green-500 text-white"
                : "bg-red-500 text-white";
            else
              cls += "bg-surface border border-border text-subtle opacity-50";

            btn.className = cls;
            btn.innerText = i + 1;
            if (ansStat !== undefined || i < state.idx) {
              btn.onclick = () => {
                state.idx = i;
                state.matchState = null;
                state.currentOrderState = null;
                render();
              };
            } else btn.classList.add("cursor-default");
            navFrag.appendChild(btn);
          }
          if (endRange < state.q.length - 1) {
            const dot = document.createElement("div");
            dot.className = "text-subtle text-xs shrink-0";
            dot.innerText = "•";
            navFrag.appendChild(dot);
          }
          els.nav.appendChild(navFrag);

          els.main.innerHTML = "";
          const wrapper = document.createElement("div");
          wrapper.className = "animate-enter max-w-4xl mx-auto w-full";
          wrapper.id = "question-card";
          wrapper.innerHTML = `<h2 class="text-lg md:text-xl font-medium text-white mb-4 md:mb-6 leading-relaxed">${q.question}</h2>`;

          const contentArea = document.createElement("div");
          contentArea.className = "w-full";

          if (q.type === "matching") {
            els.footer.classList.add("hidden");
            renderMatching(q, contentArea, isAns);
          } else {
            els.footer.classList.remove("hidden");
            if (q.type === "ordering") renderOrdering(q, contentArea, isAns);
            else renderStandard(q, contentArea, isAns);
            setupGlobalFooter(q, isAns);
          }

          wrapper.appendChild(contentArea);
          els.main.appendChild(wrapper);
        };

        const setupGlobalFooter = (q, isAns) => {
          els.prev.disabled = state.idx === 0;

          // 1. Clone the button to strip all previous event listeners
          // This ensures we don't have duplicate events firing or old logic sticking around
          const newNext = els.next.cloneNode(true);
          els.next.parentNode.replaceChild(newNext, els.next);
          els.next = newNext;

          // Helper to handle the submit logic safely on mobile
          const handleAction = (e) => {
            // Prevent double-firing (if touch triggers click, ignore the click)
            if (e.type === "click" && els.next.dataset.processed === "true") {
              els.next.dataset.processed = "";
              return;
            }
            
            // If it's a touch event, flag it so we don't double-submit on the following click
            if (e.type === "touchend") {
              e.preventDefault(); // Prevents the browser from generating a phantom click
              els.next.dataset.processed = "true";
            }

            // Execute the actual logic
            if (!isAns) {
                if (q.type === "ordering") submitOrdering(q);
                else submitStandard(q);
            } else {
                if (state.finished) switchView("result");
                else if (state.idx === state.q.length - 1) finish();
                else next();
            }
          };

          if (!isAns) {
            els.next.innerText = "Submit";
            els.next.className =
              "h-10 px-6 bg-white text-black hover:bg-gray-200 rounded-lg text-sm font-bold transition-transform active:scale-95 shadow-lg shadow-white/5 touch-manipulation select-none";
          } else {
            if (state.finished) {
              els.next.innerText = "Back to Results";
            } else {
              els.next.innerText =
                state.idx === state.q.length - 1 ? "Finish" : "Next";
            }
            els.next.className =
              "h-10 px-6 bg-surface border border-border hover:bg-white/10 text-white rounded-lg text-sm font-medium transition-colors touch-manipulation select-none";
          }

          // 2. Add listeners for BOTH click (desktop) and touchend (mobile)
          els.next.addEventListener("click", handleAction);
          els.next.addEventListener("touchend", handleAction);
        };

        const renderMatching = (q, container, isAns) => {
          if (!state.matchState) {
            state.matchState = {
              leftItems: q.leftOrder.map((i) => ({
                text: q.pairs[i].left,
                id: i,
              })),
              rightItems: shuffle(
                q.pairs.map((p, i) => ({ text: p.right, id: i }))
              ),
              userPairs: isAns ? state.ans[q.id] : [],
              selectedLeft: null,
            };
          }
          const { leftItems, rightItems } = state.matchState;

          const grid = document.createElement("div");
          grid.className = "space-y-6";
          const cols = document.createElement("div");
          cols.className = "grid grid-cols-2 gap-2 md:gap-8 relative";
          if (!isAns)
            cols.innerHTML += `<div class="absolute left-1/2 top-0 bottom-0 w-px bg-white/5 -translate-x-1/2 hidden md:block"></div>`;

          const createCol = (items, isLeft) => {
            const col = document.createElement("div");
            col.className = "flex flex-col gap-2 md:gap-3";
            items.forEach((item) => {
              const btn = document.createElement("button");
              btn.className =
                "w-full p-3 md:p-4 text-xs md:text-sm rounded-xl border text-left transition-all duration-200 break-words touch-manipulation";
              btn.dataset.id = item.id;
              btn.innerText = item.text;
              col.appendChild(btn);
            });
            return col;
          };

          const leftDOM = createCol(leftItems, true);
          const rightDOM = createCol(rightItems, false);
          cols.appendChild(leftDOM);
          cols.appendChild(rightDOM);
          grid.appendChild(cols);

          // FIX: Create Action Buttons via DOM to bind events immediately (No setTimeout)
          const actions = document.createElement("div");
          actions.className = "mt-6 pt-4 border-t border-white/5 flex gap-3";

          if (!isAns) {
            // Reset Button
            const resetBtn = document.createElement("button");
            resetBtn.id = "match-reset";
            resetBtn.className =
              "px-4 py-3 bg-surface border border-border hover:bg-white/5 text-white rounded-lg font-medium text-sm transition-colors touch-manipulation";
            resetBtn.innerText = "Reset";
            resetBtn.onclick = () => {
              state.matchState.userPairs = [];
              state.matchState.selectedLeft = null;
              updateMatchStyles(leftDOM, rightDOM, false, q);
            };

            // Submit Button
            const submitBtn = document.createElement("button");
            submitBtn.id = "match-submit";
            submitBtn.className =
              "flex-1 py-3 bg-white text-black hover:bg-gray-200 rounded-lg font-bold text-sm transition-transform active:scale-95 shadow-lg shadow-white/10 touch-manipulation";
            submitBtn.innerText = "Submit Answer";
            submitBtn.onclick = () => {
              if (state.matchState.userPairs.length < leftItems.length) {
                $("question-card").classList.add("animate-shake");
                setTimeout(
                  () => $("question-card").classList.remove("animate-shake"),
                  500
                );
                return;
              }
              let correct = 0;
              state.matchState.userPairs.forEach((p) => {
                if (p.leftId === p.rightId) correct++;
              });
              if (correct === leftItems.length) state.score++;
              state.ans[q.id] = state.matchState.userPairs;
              state.hasAnswered = true;
              saveProgress();
              render();
            };

            actions.appendChild(resetBtn);
            actions.appendChild(submitBtn);
          } else {
            // Next/Finish Button for Matching
            const nextBtn = document.createElement("button");
            nextBtn.id = "match-next";
            nextBtn.className =
              "w-full py-3 bg-surface border border-border hover:bg-white/10 text-white rounded-lg font-medium transition-colors touch-manipulation";
            nextBtn.innerText = state.finished
              ? "Back to Results"
              : state.idx === state.q.length - 1
              ? "Finish"
              : "Next Question";

            nextBtn.onclick = state.finished
              ? () => switchView("result")
              : state.idx === state.q.length - 1
              ? () => finish()
              : next;

            actions.appendChild(nextBtn);
          }

          grid.appendChild(actions);

          if (isAns && !check(q, state.ans[q.id])) {
            const correction = document.createElement("div");
            correction.className =
              "mt-6 animate-fade-in space-y-3 p-4 bg-surface rounded-xl border border-border";
            correction.innerHTML = `<h3 class="text-emerald-400 font-bold uppercase text-xs tracking-wider flex items-center gap-2"><i class="ph-fill ph-key"></i> Correct Pairs</h3>`;
            correction.innerHTML += generateMatchingCorrectionHTML(q);
            grid.appendChild(correction);
          }
          container.appendChild(grid);

          if (!isAns) {
            Array.from(leftDOM.children).forEach(
              (btn, i) =>
                (btn.onclick = () =>
                  handleMatchClick(leftItems[i], true, q, leftDOM, rightDOM))
            );
            Array.from(rightDOM.children).forEach(
              (btn, i) =>
                (btn.onclick = () =>
                  handleMatchClick(rightItems[i], false, q, leftDOM, rightDOM))
            );
          }
          updateMatchStyles(leftDOM, rightDOM, isAns, q);
        };

        const handleMatchClick = (item, isLeft, q, lDOM, rDOM) => {
          const ms = state.matchState;
          if (isLeft) {
            if (!ms.userPairs.some((p) => p.leftId === item.id)) {
              ms.selectedLeft = item;
              updateMatchStyles(lDOM, rDOM, false, q);
            }
          } else {
            if (
              !ms.userPairs.some((p) => p.rightId === item.id) &&
              ms.selectedLeft
            ) {
              ms.userPairs.push({
                leftId: ms.selectedLeft.id,
                rightId: item.id,
              });
              ms.selectedLeft = null;
              updateMatchStyles(lDOM, rDOM, false, q);
            }
          }
        };

        const updateMatchStyles = (lDOM, rDOM, isAns, q) => {
          const ms = state.matchState;
          const applyStyle = (btn, isLeft) => {
            const id = parseInt(btn.dataset.id);
            const pair = ms.userPairs.find((p) =>
              isLeft ? p.leftId === id : p.rightId === id
            );
            btn.className =
              "w-full p-3 md:p-4 text-xs md:text-sm rounded-xl border text-left transition-all duration-200 break-words touch-manipulation ";
            if (pair) {
              const c = COLORS[pair.leftId % COLORS.length];
              if (isAns) {
                const correct = pair.leftId === pair.rightId;
                btn.className += correct
                  ? `${c.bg} ${c.border} ${c.text} ring-1 ring-emerald-500`
                  : `bg-red-500/10 border-red-500/50 text-red-200`;
                btn.innerHTML =
                  btn.innerText.split("<")[0] +
                  (correct
                    ? ` <i class="ph-bold ph-check float-right mt-0.5 text-base text-emerald-400"></i>`
                    : ``);
              } else {
                btn.className += `${c.bg} ${c.border} ${c.text}`;
              }
            } else if (isLeft && ms.selectedLeft && ms.selectedLeft.id === id) {
              btn.className +=
                "bg-indigo-600 border-indigo-400 text-white ring-2 ring-indigo-400/50 scale-[1.02] shadow-lg z-10";
            } else {
              btn.className +=
                "bg-surface border-border text-subtle hover:text-white hover:border-white/20";
              if (isAns) btn.className += " opacity-30";
            }
          };
          Array.from(lDOM.children).forEach((b) => applyStyle(b, true));
          Array.from(rDOM.children).forEach((b) => applyStyle(b, false));
        };

        const renderOrdering = (q, container, isAns) => {
          if (!state.currentOrderState)
            state.currentOrderState = isAns
              ? state.ans[q.id]
              : [...q.shuffledItems];
          const list = document.createElement("ul");
          list.className = "flex flex-col gap-2 md:gap-3 relative";
          const placeholder = document.createElement("div");
          placeholder.className = "mobile-placeholder hidden";

          const getDragAfterElement = (y) => {
            const draggables = [
              ...list.querySelectorAll(
                ".draggable-item:not(.dragging):not(.dragging-mobile)"
              ),
            ];
            return draggables.reduce(
              (closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                return offset < 0 && offset > closest.offset
                  ? { offset, element: child }
                  : closest;
              },
              { offset: Number.NEGATIVE_INFINITY }
            ).element;
          };

          list.addEventListener("dragover", (e) => {
            if (isAns) return;
            e.preventDefault();
            const after = getDragAfterElement(e.clientY);
            const drag = document.querySelector(".dragging");
            if (drag)
              after == null
                ? list.appendChild(drag)
                : list.insertBefore(drag, after);
          });

          state.currentOrderState.forEach((item, index) => {
            const li = document.createElement("li");
            let base =
              "draggable-item flex items-center gap-3 md:gap-4 p-3 md:p-4 rounded-xl border transition-colors group select-none touch-manipulation ";
            if (isAns)
              base +=
                item === q.items[index]
                  ? "bg-green-500/10 border-green-500/50 text-green-200"
                  : "bg-red-500/10 border-red-500/50 text-red-200";
            else
              base +=
                "bg-surface border-border hover:border-blue-500/50 cursor-grab active:cursor-grabbing";

            li.className = base;
            li.setAttribute("draggable", !isAns);
            li.dataset.value = item;
            li.innerHTML = `<div class="p-1 pointer-events-none ${
              isAns ? "opacity-50" : "text-subtle"
            }"><i class="ph ph-dots-six-vertical text-lg md:text-xl"></i></div><span class="flex-grow font-medium pointer-events-none text-sm md:text-base">${item}</span>`;

            if (!isAns) {
              li.addEventListener("dragstart", () =>
                li.classList.add("dragging")
              );
              li.addEventListener("dragend", () => {
                li.classList.remove("dragging");
                state.currentOrderState = [
                  ...list.querySelectorAll(".draggable-item"),
                ].map((el) => el.dataset.value);
              });
              li.addEventListener(
                "touchstart",
                (e) => {
                  const t = e.touches[0];
                  const r = li.getBoundingClientRect();
                  placeholder.style.height = `${r.height}px`;
                  placeholder.classList.remove("hidden");
                  li.parentNode.insertBefore(placeholder, li);
                  li.style.position = "fixed";
                  li.style.width = `${r.width}px`;
                  li.style.left = `${r.left}px`;
                  li.style.top = `${r.top}px`;
                  li.classList.add("dragging-mobile");
                  li.dataset.startX = t.clientX;
                  li.dataset.startY = t.clientY;
                },
                { passive: false }
              );
              li.addEventListener(
                "touchmove",
                (e) => {
                  e.preventDefault();
                  const t = e.touches[0];
                  const dx = t.clientX - parseFloat(li.dataset.startX);
                  const dy = t.clientY - parseFloat(li.dataset.startY);
                  li.style.transform = `translate3d(${dx}px, ${dy}px, 0) scale(1.05)`;
                  const after = getDragAfterElement(t.clientY);
                  if (after == null) list.appendChild(placeholder);
                  else list.insertBefore(placeholder, after);
                },
                { passive: false }
              );
              li.addEventListener("touchend", (e) => {
                li.style.position = "";
                li.style.width = "";
                li.style.left = "";
                li.style.top = "";
                li.style.transform = "";
                li.classList.remove("dragging-mobile");
                placeholder.classList.add("hidden");
                if (placeholder.parentNode)
                  placeholder.parentNode.removeChild(placeholder);
                const after = getDragAfterElement(e.changedTouches[0].clientY);
                if (after == null) list.appendChild(li);
                else list.insertBefore(li, after);
                state.currentOrderState = [
                  ...list.querySelectorAll(".draggable-item"),
                ].map((el) => el.dataset.value);
              });
            }
            list.appendChild(li);
          });
          container.appendChild(list);

          if (isAns && !check(q, state.ans[q.id])) {
            container.innerHTML += `<div class="mt-4 pt-4 border-t border-dashed border-white/10 animate-fade-in"><h3 class="text-xs font-bold text-green-400 uppercase tracking-wider mb-2">Correct Sequence</h3><ol class="space-y-2">${q.items
              .map(
                (item, i) =>
                  `<li class="flex items-center gap-3 p-2 rounded-lg bg-green-500/5 border border-green-500/10 text-green-200 text-xs md:text-sm"><span class="font-bold text-green-500">${
                    i + 1
                  }.</span> ${item}</li>`
              )
              .join("")}</ol></div>`;
          }
        };

        const submitOrdering = (q) => {
          const userOrder = state.currentOrderState;
          if (JSON.stringify(userOrder) === JSON.stringify(q.items))
            state.score++;
          else {
            $("question-card").classList.add("animate-shake");
            setTimeout(
              () => $("question-card").classList.remove("animate-shake"),
              500
            );
          }
          state.ans[q.id] = userOrder;
          state.hasAnswered = true;
          saveProgress();
          render();
        };

        const renderStandard = (q, container, isAns) => {
          const inputArea = document.createElement("div");
          inputArea.className = "space-y-3";
          inputArea.id = "std-inputs";
          if (q.type === "short_answer") {
            const input = document.createElement("input");
            input.type = "text";
            input.className =
              "w-full p-4 rounded-xl bg-surface border border-border text-white focus:outline-none focus:border-white transition-colors text-sm md:text-base";
            input.placeholder = "Type your answer here...";
            if (isAns) {
              const val = state.ans[q.id] || "";
              input.value = val;
              input.setAttribute("value", val);
              input.disabled = true;
              const correct = check(q, val);
              input.className = correct
                ? "w-full p-4 rounded-xl bg-green-500/10 border border-green-500 text-green-200 text-sm md:text-base"
                : "w-full p-4 rounded-xl bg-red-500/10 border border-red-500 text-red-200 text-sm md:text-base";
            }
            inputArea.appendChild(input);
            // Removed input.focus() here to prevent mobile keyboard layout shift issues
          } else {
            const baseStyle =
              "w-full text-left p-4 rounded-xl border text-sm md:text-base transition-all border-border bg-surface/50 hover:border-white/50 hover:bg-surface text-subtle hover:text-white touch-manipulation";
            const activeStyle =
              "w-full text-left p-4 rounded-xl border text-sm md:text-base transition-all border-white bg-white text-black font-medium shadow-lg touch-manipulation";
            (q.type === "true_false" ? ["True", "False"] : q.options).forEach(
              (opt) => {
                const btn = document.createElement("button");
                const val = q.type === "true_false" ? opt === "True" : opt;
                if (!isAns) {
                  btn.className = baseStyle;
                  btn.onclick = () => {
                    // FIX: Loop through ALL buttons to reset style AND delete data-val
                    inputArea
                      .querySelectorAll("button")
                      .forEach((b) => {
                        b.className = baseStyle;
                        delete b.dataset.val;
                      });
                    
                    // Set active style and data-val on clicked button
                    btn.className = activeStyle;
                    btn.dataset.val = JSON.stringify(val);
                  };
                } else {
                  const selected = state.ans[q.id] === val;
                  const correct = q.correct === val;
                  let cls =
                    "w-full text-left p-4 rounded-xl border text-sm md:text-base transition-all ";
                  if (selected)
                    cls += correct
                      ? "border-green-500 bg-green-500/10 text-white"
                      : "border-red-500 bg-red-500/10 text-white";
                  else if (correct)
                    cls += "border-green-500/30 text-green-500 opacity-60";
                  else cls += "border-border opacity-20";
                  btn.className = cls;
                }
                btn.innerText = opt;
                inputArea.appendChild(btn);
              }
            );
          }
          container.appendChild(inputArea);
          if (isAns && !check(q, state.ans[q.id]))
            container.innerHTML += `<div class="mt-4 p-4 bg-red-500/5 border border-red-500/10 rounded-xl animate-slide-down"><div class="text-xs font-bold text-red-400 uppercase mb-1">Incorrect</div><div class="text-sm text-subtle">Correct Answer: <span class="text-white">${formatAnswer(
              q.correct
            )}</span></div></div>`;
        };

        const submitStandard = (q) => {
          let ans = null;
          if (q.type === "short_answer") {
            const input = document.querySelector("#std-inputs input");
            if (input && input.value.trim() !== "") ans = input.value.trim();
          } else {
            const sel = document.querySelector("#std-inputs button[data-val]");
            if (sel) ans = JSON.parse(sel.dataset.val);
          }
          if (ans === null) return;
          if (check(q, ans)) state.score++;
          state.ans[q.id] = ans;
          state.hasAnswered = true;
          saveProgress();
          render();
        };

        const check = (q, ans) => {
          if (q.type === "matching") {
            if (!ans) return false;
            let c = 0;
            ans.forEach((p) => {
              if (p.leftId === p.rightId) c++;
            });
            return c === q.pairs.length;
          }
          if (q.type === "ordering")
            return JSON.stringify(ans) === JSON.stringify(q.items);
          
          if (q.type === "short_answer") {
            // FIX: Convert to String to handle numbers in JSON safely
            if (q.correct === undefined || q.correct === null) return false;
            return String(ans).trim().toLowerCase() === String(q.correct).trim().toLowerCase();
          }
          
          return ans === q.correct;
        };

        const next = () => {
          state.idx++;
          state.matchState = null;
          state.currentOrderState = null;
          saveProgress();
          render();
        };

        const finish = () => {
          state.finished = true;
          clearProgress();
          switchView("result");
          els.resScore.innerText = Math.round(
            (state.score / state.q.length) * 100
          );
          els.revList.innerHTML = "";

          const frag = document.createDocumentFragment();
          state.q.forEach((q, i) => {
            try {
              const ans = state.ans[q.id];
              if (ans === undefined) return;

              const isCorrect = check(q, ans);
              const card = document.createElement("div");
              card.onclick = () => reviewQuestion(i);
              card.className = `p-4 border border-border rounded-xl cursor-pointer transition-all hover:bg-white/5 ${
                isCorrect ? "bg-green-500/5" : "bg-red-500/5"
              }`;

              let correction = "";
              if (!isCorrect) {
                if (q.type === "matching")
                  correction = generateMatchingCorrectionHTML(q);
                else if (q.type === "ordering")
                  correction = `<div class="mt-3 space-y-1">${q.items
                    .map(
                      (it, idx) =>
                        `<div class="flex items-center gap-2 p-1.5 rounded bg-green-500/10 border border-green-500/20 text-xs text-green-200"><span class="font-bold">${
                          idx + 1
                        }.</span> ${it}</div>`
                    )
                    .join("")}</div>`;
                else {
                  let userAnsDisp =
                    ans !== undefined
                      ? `<span class="text-red-400 line-through mr-2 opacity-70 text-xs">${formatAnswer(
                          ans
                        )}</span>`
                      : "";
                  correction = `<div class="mt-2 text-xs md:text-sm text-subtle">${userAnsDisp}Correct: <span class="text-white font-medium">${formatAnswer(
                    q.correct
                  )}</span></div>`;
                }
              }

              card.innerHTML = `
                            <div class="flex items-start gap-3">
                                <div class="${
                                  isCorrect ? "text-green-500" : "text-red-500"
                                } mt-0.5"><i class="ph-fill ${
                isCorrect ? "ph-check-circle" : "ph-x-circle"
              } text-lg"></i></div>
                                <div class="w-full min-w-0">
                                    <div class="text-xs text-subtle mb-1">Question ${
                                      i + 1
                                    }</div>
                                    <div class="text-sm font-medium text-white truncate">${
                                      q.question
                                    }</div>
                                    ${correction}
                                </div>
                            </div>`;
              frag.appendChild(card);
            } catch (e) {
              console.error(e);
            }
          });
          if (frag.childNodes.length === 0)
            els.revList.innerHTML =
              '<div class="text-subtle text-center text-sm">No answered questions to review.</div>';
          else els.revList.appendChild(frag);
        };

        return {
          init,
          start: startNewGame,
          quit: () => location.reload(),
          prev: () => {
            state.idx--;
            state.matchState = null;
            state.currentOrderState = null;
            saveProgress();
            render();
          },
          restart,
          endSession,
        };
      })();
    </script>
  </body>
</html>
